<?php

namespace app\controller;

use app\model\Model;
use app\model\Openanswer;
use app\model\Openquestion;
use app\model\Opentest;
use app\model\User;
use app\view\OpenTest\OpentestView;
use app\view\View;


class OpentestController extends AppController
{
	public $model = 'opentest';
	public $table = 'opentests';

	public function __construct(array $route)
	{
		parent::__construct($route);

	}

	public function actionIndex()
	{
	}

	public function actionUpdate()
	{
		if ($this->ajax) {
			$id = Opentest::update($this->ajax);
			$this->exitJson(['id' => $id]);
		}
		$this->view = 'edit_update';

		$id = $this->route['id'];
		$item = OpentestView::getUpdateView($id);
		$this->set(compact('item'));
	}


	public function actionShow()
	{
		$this->view = 'edit_show';

		$page_name = 'Создание открытого теста';
		$this->set(compact('page_name'));

		$isTest = 1;
		$this->set(compact('isTest'));

		$id = $this->route['id'] ?? null;

		$test = new Opentest;
		$test->fillable['id'] = $id;

		$item = OpentestView::getShowView($test);
		$this->set(compact('item'));

	}

	public function actionPathshow()
	{
		$this->view = 'edit_show';

		$page_name = 'Создание открытого теста';
		$this->set(compact('page_name'));

		$isTest = 0;
		$this->set(compact('isTest'));

		$id = $this->route['id'] ?? null;

		$test = new Opentest;
		$test->fillable['id'] = $id;

		$item = OpentestView::getShowView($test);
		$this->set(compact('item'));

	}

	public function actionUpdateOrCreate()
	{
		if ($this->ajax) {
			if ($id = Opentest::updateOrCreate($this->ajax)) {
				$q_id = Openquestion::create(['opentest_id' => $id - 1]);
				exit(json_encode([
					'id' => $id,
				]));
			}
		}
	}

	public function actionDelete()
	{
		if (User::can($this->user, 'test_delete') || defined('SU')) {
			if (Opentest::delete($this->ajax['id'])) {
				$this->exitWithPopup('ok');
			}
		}
		$this->ajax['test']['enable'] = 0;
		$this->ajax['test']['id'] = $this->ajax['id'];
		Opentest::update($this->ajax['test']);
		exit(json_encode(['notAdmin' => true]));
	}

	public function actionDo()
	{
		$page_name = 'Прохождение открытых тестов';
		$this->set(compact('page_name'));
		$accordion = OpentestView::oldDoAccordion();
		$this->set(compact('accordion'));

		$testId = isset($this->route['id']) ? (int)$this->route['id'] : '';
		$test = Opentest::findOneWhere('id', $testId);
		if ($test) {
			$questions = Openquestion::where('opentest_id', '=', $testId)
				->orderBy('sort')->get();
			foreach ($questions as &$question) {
				$question['answers'] = Openanswer::where('openquestion_id', '=', $question['id'])
					->get();
			}
			$test['questions'] = $questions;

			$this->set(compact('test'));
		}
	}

	public function actionQuestions()
	{
		$testId = (int)$this->route['id'];
		$html = OpentestView::getQuetionsView(Opentest::findOneModel($testId));
		$this->set(compact('html'));
	}

	private function getQuestions($testId)
	{
		return Openquestion::where('opentest_id', '=', $testId)
			->orderBy('sort')
			->get();
	}

	public function actionEdit()
	{
		$test = '';
		$page_name = 'Редактирование открытых тестов';
		$this->set(compact('page_name'));

		if (!isset($this->route['id'])) {
			$error = 'Выберите тест';
			$this->set(compact('error'));

		} else {
			$testId = (int)$this->route['id'];
			$test = Opentest::findOneWhere('id', $testId);
			if ($test) {
				$questions = $this->getQuestions($testId);
				if (!$questions) {
					Openquestion::create(['opentest_id' => $testId]);
					$questions = $this->getQuestions($testId);
				}
				foreach ($questions as &$question) {
					$question['answers'] = Openanswer::findAllWhere('openquestion_id', $question['id']);
				}
				$test['questions'] = $questions;

				$this->set(compact('test'));

				$tests = Opentest::findAllWhere('isTest', '1');
				$this->set(compact('tests'));
			}
		}

	}

	public function actionTests()
	{
		$this->exitJson(Opentest::findAllWhere('isTest', '1'));
	}


	public function actionPaths()
	{
		$this->exitJson(Opentest::findAllWhere('isTest', '0'));
	}


	public function actionGetCorrectAnswers()
	{
		Opentest::getCorrectAnswers();
	}


}
