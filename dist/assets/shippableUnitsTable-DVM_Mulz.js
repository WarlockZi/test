import{a as l,q as s,b as u,e as o,p as a}from"./index-DSMixOGv.js";class p{constructor(t){if(!t)return!1;this.target=t,this.table=t.closest("[shippable-table]"),this.table[l]("click",this.handleClick.bind(this)),this.blueButton=this.table[s](".blue-button"),this.greenButtonWrap=this.table[s](".green-button-wrap")??!1,this.price=+this.table.dataset.price,this.sid=this.table.dataset["1sid"],this.total=this.table[s]("[data-total]"),this.setFormatter(),this.showButtons(),this.renderSums()}showButtons(){if(!this.blueButton||!this.greenButtonWrap)return!1;this.getTotalCount()?(this.blueButton.style.display="none",this.greenButtonWrap.style.display="flex"):(this.blueButton.style.display="flex",this.greenButtonWrap.style.display="none")}handleClick({target:t}){const e=t??this.target;if(e.classList.contains("blue-button"))this.showGreenButton(e);else if(e.classList.contains("green-button"))window.location.href="/cart";else if(e.classList.contains("plus")){const i=e.closest(".unit-row");this.increment(i)}else if(e.classList.contains("minus")){const i=e.closest(".unit-row");this.decrement(i)}else if(e.classList.contains("input")){const i=e.closest(".unit-row");this.handleChange(i)}return this}increment(t){t[s]("input").value++,t.dataset.rowSum=""+t[s]("input").value,this.handleChange(t)}decrement(t){const e=t[s]("input");+e.value<2?e.value="":(e.value--,t.dataset.rowSum=e.value),this.handleChange(t)}getTotalCount(){return[...this.table[u]("input")].reduce((t,e)=>t+ +e.value,0)}handleChange(t){const e=this.getTotalCount(t);this.renderSums(),e===0?this.showBlueButton():this.toServer(this.dto(t))}renderSums(){let t=[...this.table[u](".unit-row")].reduce((e,i,c)=>{const n=this.rowDto(i);let r=+this.price*+n.multiplier*+n.count;return n.sub_sum&&(n.sub_sum.innerText=this.formatter.format(r)),e+r},0);this.total&&(this.total.innerText=this.formatter.format(t))}showBlueButton(){if(!this.blueButton)return!1;this.getTotalCount()||(this.greenButtonWrap.style.display="none",this.greenButtonWrap[s]("input").value="0",this.blueButton.style.display="flex",this.deleteOrderItems(this.tableDTO(this.table)))}showGreenButton(){if(!this.greenButtonWrap)return!1;this.greenButtonWrap.style.display="flex";const t=+this.greenButtonWrap[s]("input").value;this.greenButtonWrap[s]("input").value=t||1,this.blueButton.style.display="none",this.toServer(this.dto(this.greenButtonWrap[s]("[unit-row]")))}getUrl(){return o()?"/adminsc/order":"/adminsc/orderitem"}deleteOrderItems(t){const e=`${this.getUrl()}/delete`;a(e,t)}async toServer(t){const e=`${this.getUrl()}/updateOrCreate`;await a(e,t)}setFormatter(){this.formatter=new Intl.NumberFormat("ru",{style:"currency",currency:"RUB",minimumFractionDigits:2})}rowDto(t){return{count:t[s]("input").value,multiplier:t.dataset.multiplier,sub_sum:t[s](".sub-sum")}}tableDTO(t){return{unit_ids:this.unitIds(t),product_id:this.sid}}unitIds(t){return[...t[u]("[unit-row]")].map(e=>e.dataset.unitid)}dto(t){return{count:t[s]("input").value,unit_id:t.dataset.unitid,product_id:this.sid}}}export{p as s};
