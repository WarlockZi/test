{"version":3,"file":"Cart-DhquycOR.js","sources":["../../src/Cart/Cart.js"],"sourcesContent":["import './counter1'\r\nimport {$, formatter, getPhpSession, post} from '../common'\r\nimport {ael, it, qa, qs} from '../constants';\r\nimport shippableTable from \"../share/shippable/shippableUnitsTable\";\r\n\r\nexport default class Cart {\r\n   constructor() {\r\n      this.container = $('.user-content .cart .content').first();\r\n      if (!this.container) return;\r\n\r\n      this.container[ael]('click', this.handleClick.bind(this));\r\n      this.container[ael]('keyup', this.handleKeyUp.bind(this));\r\n\r\n      this.total = this.container[qs]('.total span');\r\n      this.$cartEmptyText = this.container[qs]('.empty-cart');\r\n      this.$cartCount = this.container[qs]('.cart .count');\r\n      this.rows = this.container[qa]('.row');\r\n\r\n      this.mapTables()\r\n      this.renderSums()\r\n   }\r\n\r\n   async submitCart() {\r\n      const rows = [].map.call(this.rows, (row) => {\r\n         return this.cartRowDTO(row)\r\n      })\r\n      rows.sess = getPhpSession()\r\n      const res = post('/cart/submit', rows)\r\n\r\n\r\n   }\r\n\r\n   rowUnits(row) {\r\n      const rows = {};\r\n      [...row[qa]('[unit-row]')].map((unitRow) => {\r\n         const key = unitRow.dataset.unitid\r\n         rows[key] = unitRow[qs]('input').value\r\n      })\r\n      return rows\r\n   }\r\n\r\n   cartRowDTO(target) {\r\n      const row = target.closest('.row');\r\n      return {\r\n         product_id: row.dataset.productId,\r\n         units: this.rowUnits(row),\r\n      }\r\n   }\r\n\r\n   renderSums() {\r\n      const total = [...this.container[qa]('[shippable-table]')]\r\n         .reduce((acc, table) => {\r\n            const price = +table.dataset.price;\r\n            const sum = [...table[qa]('[unit-row]')].reduce(\r\n               function (acc, unitRow) {\r\n                  const multi = +unitRow.dataset.multiplier\r\n                  const count = +unitRow[qs]('input').value\r\n                  const sum = multi * price * count\r\n                  const sub_sum = unitRow[qs]('.subSum')\r\n                  if (sub_sum) sub_sum[it] = formatter.format(sum)\r\n                  return acc + sum\r\n               }.bind(price), 0)\r\n            const tableSum = table.closest('.row')[qs]('.sub-sum')\r\n            tableSum[it] = formatter.format(sum)\r\n            return acc + sum\r\n         }, 0)\r\n      this.total[it] = formatter.format(total)\r\n   }\r\n\r\n   mapTables() {\r\n      [...this.container[qa]('.shippable-table')]\r\n         .forEach((table) => {\r\n            new shippableTable(table)\r\n         })\r\n   }\r\n\r\n   async dropCart() {\r\n      const cartToken = getPhpSession();\r\n      const res = await post('/cart/drop', {cartToken});\r\n      if (res?.arr?.ok) {\r\n         this.showEmptyCart()\r\n      }\r\n   }\r\n\r\n\r\n   async handleClick({target}) {\r\n      if (target.classList.contains('del')) {\r\n         await this.deleteCartRow(target)\r\n         this.renderSums()\r\n      } else if (target.classList.contains('plus') || target.classList.contains('minus')) {\r\n         if (this.rowTotalCount(target.closest('.row'))) {\r\n            this.renderSums()\r\n         } else {\r\n            this.renderSums()\r\n         }\r\n      } else if (target.id === 'cartSubmit') {\r\n         YM('cart_submitted')\r\n         this.submitCart()\r\n      }\r\n   }\r\n\r\n\r\n   async handleKeyUp({target}) {\r\n      if (target.classList.contains('input') && target.tagName === 'INPUT') {\r\n         this.renderSums()\r\n         const count = +target.value\r\n         this.updateOrCreate(target, count)\r\n      }\r\n   }\r\n\r\n   rowTotalCount(table) {\r\n      return [...table[qa]('input')].reduce((acc, el) => {\r\n         return acc + (+el.value)\r\n      }, 0)\r\n   }\r\n\r\n   updateOrCreate(target, count) {\r\n      const product_id = target.closest('[shippable-table]').dataset['1sid'];\r\n      const unit_id = target.closest('[unit-row]').dataset['unitid'];\r\n      post(`/cart/updateOrCreate`, {product_id, unit_id, count})\r\n   }\r\n\r\n   async deleteCartRow(target) {\r\n      const res = await post(`/cart/deleteRow`, this.cartRowDTO(target));\r\n      if (res?.arr?.ok) {\r\n         target.closest('.row').remove();\r\n         if (this.rows.length < 1) this.showEmptyCart()\r\n         this.renderSums()\r\n      }\r\n   }\r\n\r\n   showEmptyCart() {\r\n      this.container.innerHTML = '';\r\n      this.$cartEmptyText.classList.remove('none')\r\n      this.$cartCount.classList.add('none')\r\n   }\r\n\r\n   // counterCallback() {\r\n   //    cookieRemove('cartDeadline')\r\n   //    this.dropCart().then()\r\n   // }\r\n\r\n}"],"names":["Cart","$","ael","qs","qa","rows","row","getPhpSession","post","unitRow","key","target","total","acc","table","price","sum","multi","count","sub_sum","it","formatter","tableSum","shippableTable","cartToken","el","product_id","unit_id"],"mappings":"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"}