{"version":3,"file":"Cart-Cjk0iGKh.js","sources":["../../src/Cart/Cart.js"],"sourcesContent":["import \"./counter1\";\r\nimport { $, formatter, getPhpSession, post } from \"../common\";\r\nimport { ael, it, qa, qs } from \"../constants\";\r\nimport shippableTable from \"../share/shippable/shippableUnitsTable\";\r\n\r\nexport default class Cart {\r\n  constructor() {\r\n    this.container = $(\".user-content .cart .content\").first();\r\n    if (!this.container) return;\r\n\r\n    this.container[ael](\"click\", this.handleClick.bind(this));\r\n    this.container[ael](\"keyup\", this.handleKeyUp.bind(this));\r\n\r\n    this.orderId = this.container[qs](\"[data-order-id]\").dataset.orderId;\r\n    this.total = this.container[qs](\".total span\");\r\n    this.$cartEmptyText = this.container[qs](\".empty-cart\");\r\n    this.$cartCount = this.container[qs](\".cart .count\");\r\n    this.rows = this.container[qa](\".row\");\r\n\r\n    this.mapTables();\r\n    this.renderSums();\r\n  }\r\n\r\n  async submitCart() {\r\n    // const rows = [].map.call(this.rows, (row) => {\r\n    //    return this.cartRowDTO(row)\r\n    // })\r\n    const orderId = this.orderId;\r\n\r\n    const res = post(\"/cart/submit\", { orderId });\r\n    if (res.ok) {\r\n    }\r\n  }\r\n\r\n  rowUnits(row) {\r\n    const rows = {};\r\n    [...row[qa](\"[unit-row]\")].map((unitRow) => {\r\n      const unitid = unitRow.dataset.unitid;\r\n      const count = +unitRow[qs](\"input\").value;\r\n      if (count) rows[unitid] = count;\r\n    });\r\n    return rows;\r\n  }\r\n\r\n  cartRowDTO(target) {\r\n    const row = target.closest(\".row\");\r\n    return {\r\n      product_id: row.dataset.productId,\r\n      units: this.rowUnits(row),\r\n    };\r\n  }\r\n\r\n  renderSums() {\r\n    const total = [...this.container[qa](\"[shippable-table]\")].reduce(\r\n      (acc, table) => {\r\n        const price = +table.dataset.price;\r\n        const sum = [...table[qa](\"[unit-row]\")].reduce(\r\n          function (acc, unitRow) {\r\n            const multi = +unitRow.dataset.multiplier;\r\n            const count = +unitRow[qs](\"input\").value;\r\n            const sum = multi * price * count;\r\n            const sub_sum = unitRow[qs](\".subSum\");\r\n            if (sub_sum) sub_sum[it] = formatter.format(sum);\r\n            return acc + sum;\r\n          }.bind(price),\r\n          0,\r\n        );\r\n        const tableSum = table.closest(\".row\")[qs](\".sub-sum\");\r\n        tableSum[it] = formatter.format(sum);\r\n        return acc + sum;\r\n      },\r\n      0,\r\n    );\r\n    this.total[it] = formatter.format(total);\r\n  }\r\n\r\n  mapTables() {\r\n    [...this.container[qa](\".shippable-table\")].forEach((table) => {\r\n      new shippableTable(table);\r\n    });\r\n  }\r\n\r\n  async dropCart() {\r\n    const cartToken = getPhpSession();\r\n    const res = await post(\"/cart/drop\", { cartToken });\r\n    if (res?.arr?.ok) {\r\n      this.showEmptyCart();\r\n    }\r\n  }\r\n\r\n  async handleClick({ target }) {\r\n    if (target.classList.contains(\"del\")) {\r\n      await this.deleteCartRow(target);\r\n      this.renderSums();\r\n    } else if (\r\n      target.classList.contains(\"plus\") ||\r\n      target.classList.contains(\"minus\")\r\n    ) {\r\n      if (this.rowTotalCount(target.closest(\".row\"))) {\r\n        this.renderSums();\r\n      } else {\r\n        this.renderSums();\r\n      }\r\n    } else if (target.id === \"cartSubmit\") {\r\n      YM(\"cart_submitted\");\r\n      this.submitCart();\r\n    }\r\n  }\r\n\r\n  async handleKeyUp({ target }) {\r\n    if (target.classList.contains(\"input\") && target.tagName === \"INPUT\") {\r\n      this.renderSums();\r\n      const count = +target.value;\r\n      this.updateOrCreate(target, count);\r\n    }\r\n  }\r\n\r\n  rowTotalCount(table) {\r\n    return [...table[qa](\"input\")].reduce((acc, el) => {\r\n      return acc + +el.value;\r\n    }, 0);\r\n  }\r\n\r\n  updateOrCreate(target, count) {\r\n    const product_id = target.closest(\"[shippable-table]\").dataset[\"1sid\"];\r\n    const unit_id = target.closest(\"[unit-row]\").dataset[\"unitid\"];\r\n    post(`/cart/updateOrCreate`, { product_id, unit_id, count });\r\n  }\r\n\r\n  async deleteCartRow(target) {\r\n    const res = await post(`/cart/deleteRow`, this.cartRowDTO(target));\r\n    if (res?.arr?.ok) {\r\n      target.closest(\".row\").remove();\r\n      if (this.rows.length < 1) this.showEmptyCart();\r\n      this.renderSums();\r\n    }\r\n  }\r\n\r\n  showEmptyCart() {\r\n    this.container.innerHTML = \"\";\r\n    this.$cartEmptyText.classList.remove(\"none\");\r\n    this.$cartCount.classList.add(\"none\");\r\n  }\r\n\r\n  // counterCallback() {\r\n  //    cookieRemove('cartDeadline')\r\n  //    this.dropCart().then()\r\n  // }\r\n}\r\n"],"names":["Cart","$","ael","qs","qa","orderId","post","row","rows","unitRow","unitid","count","target","total","acc","table","price","sum","multi","sub_sum","it","formatter","tableSum","shippableTable","cartToken","getPhpSession","el","product_id","unit_id"],"mappings":"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"}