{"version":3,"file":"Cart-Cjk0iGKh.js","sources":["../../src/Cart/Cart.js"],"sourcesContent":["import \"./counter1\";\nimport { $, formatter, getPhpSession, post } from \"../common\";\nimport { ael, it, qa, qs } from \"../constants\";\nimport shippableTable from \"../share/shippable/shippableUnitsTable\";\n\nexport default class Cart {\n  constructor() {\n    this.container = $(\".user-content .cart .content\").first();\n    if (!this.container) return;\n\n    this.container[ael](\"click\", this.handleClick.bind(this));\n    this.container[ael](\"keyup\", this.handleKeyUp.bind(this));\n\n    this.orderId = this.container[qs](\"[data-order-id]\").dataset.orderId;\n    this.total = this.container[qs](\".total span\");\n    this.$cartEmptyText = this.container[qs](\".empty-cart\");\n    this.$cartCount = this.container[qs](\".cart .count\");\n    this.rows = this.container[qa](\".row\");\n\n    this.mapTables();\n    this.renderSums();\n  }\n\n  async submitCart() {\n    // const rows = [].map.call(this.rows, (row) => {\n    //    return this.cartRowDTO(row)\n    // })\n    const orderId = this.orderId;\n\n    const res = post(\"/cart/submit\", { orderId });\n    if (res.ok) {\n    }\n  }\n\n  rowUnits(row) {\n    const rows = {};\n    [...row[qa](\"[unit-row]\")].map((unitRow) => {\n      const unitid = unitRow.dataset.unitid;\n      const count = +unitRow[qs](\"input\").value;\n      if (count) rows[unitid] = count;\n    });\n    return rows;\n  }\n\n  cartRowDTO(target) {\n    const row = target.closest(\".row\");\n    return {\n      product_id: row.dataset.productId,\n      units: this.rowUnits(row),\n    };\n  }\n\n  renderSums() {\n    const total = [...this.container[qa](\"[shippable-table]\")].reduce(\n      (acc, table) => {\n        const price = +table.dataset.price;\n        const sum = [...table[qa](\"[unit-row]\")].reduce(\n          function (acc, unitRow) {\n            const multi = +unitRow.dataset.multiplier;\n            const count = +unitRow[qs](\"input\").value;\n            const sum = multi * price * count;\n            const sub_sum = unitRow[qs](\".subSum\");\n            if (sub_sum) sub_sum[it] = formatter.format(sum);\n            return acc + sum;\n          }.bind(price),\n          0,\n        );\n        const tableSum = table.closest(\".row\")[qs](\".sub-sum\");\n        tableSum[it] = formatter.format(sum);\n        return acc + sum;\n      },\n      0,\n    );\n    this.total[it] = formatter.format(total);\n  }\n\n  mapTables() {\n    [...this.container[qa](\".shippable-table\")].forEach((table) => {\n      new shippableTable(table);\n    });\n  }\n\n  async dropCart() {\n    const cartToken = getPhpSession();\n    const res = await post(\"/cart/drop\", { cartToken });\n    if (res?.arr?.ok) {\n      this.showEmptyCart();\n    }\n  }\n\n  async handleClick({ target }) {\n    if (target.classList.contains(\"del\")) {\n      await this.deleteCartRow(target);\n      this.renderSums();\n    } else if (\n      target.classList.contains(\"plus\") ||\n      target.classList.contains(\"minus\")\n    ) {\n      if (this.rowTotalCount(target.closest(\".row\"))) {\n        this.renderSums();\n      } else {\n        this.renderSums();\n      }\n    } else if (target.id === \"cartSubmit\") {\n      YM(\"cart_submitted\");\n      this.submitCart();\n    }\n  }\n\n  async handleKeyUp({ target }) {\n    if (target.classList.contains(\"input\") && target.tagName === \"INPUT\") {\n      this.renderSums();\n      const count = +target.value;\n      this.updateOrCreate(target, count);\n    }\n  }\n\n  rowTotalCount(table) {\n    return [...table[qa](\"input\")].reduce((acc, el) => {\n      return acc + +el.value;\n    }, 0);\n  }\n\n  updateOrCreate(target, count) {\n    const product_id = target.closest(\"[shippable-table]\").dataset[\"1sid\"];\n    const unit_id = target.closest(\"[unit-row]\").dataset[\"unitid\"];\n    post(`/cart/updateOrCreate`, { product_id, unit_id, count });\n  }\n\n  async deleteCartRow(target) {\n    const res = await post(`/cart/deleteRow`, this.cartRowDTO(target));\n    if (res?.arr?.ok) {\n      target.closest(\".row\").remove();\n      if (this.rows.length < 1) this.showEmptyCart();\n      this.renderSums();\n    }\n  }\n\n  showEmptyCart() {\n    this.container.innerHTML = \"\";\n    this.$cartEmptyText.classList.remove(\"none\");\n    this.$cartCount.classList.add(\"none\");\n  }\n\n  // counterCallback() {\n  //    cookieRemove('cartDeadline')\n  //    this.dropCart().then()\n  // }\n}\n"],"names":["Cart","$","ael","qs","qa","orderId","post","row","rows","unitRow","unitid","count","target","total","acc","table","price","sum","multi","sub_sum","it","formatter","tableSum","shippableTable","cartToken","getPhpSession","el","product_id","unit_id"],"mappings":"qLAKe,MAAMA,CAAK,CACxB,aAAc,CACZ,KAAK,UAAYC,EAAE,8BAA8B,EAAE,MAAO,EACrD,KAAK,YAEV,KAAK,UAAUC,CAAG,EAAE,QAAS,KAAK,YAAY,KAAK,IAAI,CAAC,EACxD,KAAK,UAAUA,CAAG,EAAE,QAAS,KAAK,YAAY,KAAK,IAAI,CAAC,EAExD,KAAK,QAAU,KAAK,UAAUC,CAAE,EAAE,iBAAiB,EAAE,QAAQ,QAC7D,KAAK,MAAQ,KAAK,UAAUA,CAAE,EAAE,aAAa,EAC7C,KAAK,eAAiB,KAAK,UAAUA,CAAE,EAAE,aAAa,EACtD,KAAK,WAAa,KAAK,UAAUA,CAAE,EAAE,cAAc,EACnD,KAAK,KAAO,KAAK,UAAUC,CAAE,EAAE,MAAM,EAErC,KAAK,UAAW,EAChB,KAAK,WAAY,EACrB,CAEE,MAAM,YAAa,CAIjB,MAAMC,EAAU,KAAK,QAETC,EAAK,eAAgB,CAAE,QAAAD,CAAO,CAAE,EACpC,EAEZ,CAEE,SAASE,EAAK,CACZ,MAAMC,EAAO,CAAE,EACf,OAAC,GAAGD,EAAIH,CAAE,EAAE,YAAY,CAAC,EAAE,IAAKK,GAAY,CAC1C,MAAMC,EAASD,EAAQ,QAAQ,OACzBE,EAAQ,CAACF,EAAQN,CAAE,EAAE,OAAO,EAAE,MAChCQ,IAAOH,EAAKE,CAAM,EAAIC,EAChC,CAAK,EACMH,CACX,CAEE,WAAWI,EAAQ,CACjB,MAAML,EAAMK,EAAO,QAAQ,MAAM,EACjC,MAAO,CACL,WAAYL,EAAI,QAAQ,UACxB,MAAO,KAAK,SAASA,CAAG,CACzB,CACL,CAEE,YAAa,CACX,MAAMM,EAAQ,CAAC,GAAG,KAAK,UAAUT,CAAE,EAAE,mBAAmB,CAAC,EAAE,OACzD,CAACU,EAAKC,IAAU,CACd,MAAMC,EAAQ,CAACD,EAAM,QAAQ,MACvBE,EAAM,CAAC,GAAGF,EAAMX,CAAE,EAAE,YAAY,CAAC,EAAE,OACvC,SAAUU,EAAKL,EAAS,CACtB,MAAMS,EAAQ,CAACT,EAAQ,QAAQ,WACzBE,EAAQ,CAACF,EAAQN,CAAE,EAAE,OAAO,EAAE,MAC9Bc,EAAMC,EAAQF,EAAQL,EACtBQ,EAAUV,EAAQN,CAAE,EAAE,SAAS,EACrC,OAAIgB,IAASA,EAAQC,CAAE,EAAIC,EAAU,OAAOJ,CAAG,GACxCH,EAAMG,CACzB,EAAY,KAAKD,CAAK,EACZ,CACD,EACKM,EAAWP,EAAM,QAAQ,MAAM,EAAEZ,CAAE,EAAE,UAAU,EACrD,OAAAmB,EAASF,CAAE,EAAIC,EAAU,OAAOJ,CAAG,EAC5BH,EAAMG,CACd,EACD,CACD,EACD,KAAK,MAAMG,CAAE,EAAIC,EAAU,OAAOR,CAAK,CAC3C,CAEE,WAAY,CACV,CAAC,GAAG,KAAK,UAAUT,CAAE,EAAE,kBAAkB,CAAC,EAAE,QAASW,GAAU,CAC7D,IAAIQ,EAAeR,CAAK,CAC9B,CAAK,CACL,CAEE,MAAM,UAAW,CACf,MAAMS,EAAYC,EAAe,GACrB,MAAMnB,EAAK,aAAc,CAAE,UAAAkB,CAAS,CAAE,IACzC,KAAK,IACZ,KAAK,cAAe,CAE1B,CAEE,MAAM,YAAY,CAAE,OAAAZ,GAAU,CACxBA,EAAO,UAAU,SAAS,KAAK,GACjC,MAAM,KAAK,cAAcA,CAAM,EAC/B,KAAK,WAAY,GAEjBA,EAAO,UAAU,SAAS,MAAM,GAChCA,EAAO,UAAU,SAAS,OAAO,EAE7B,KAAK,cAAcA,EAAO,QAAQ,MAAM,CAAC,EAC3C,KAAK,WAAY,EAEjB,KAAK,WAAY,EAEVA,EAAO,KAAO,eACvB,GAAG,gBAAgB,EACnB,KAAK,WAAY,EAEvB,CAEE,MAAM,YAAY,CAAE,OAAAA,GAAU,CAC5B,GAAIA,EAAO,UAAU,SAAS,OAAO,GAAKA,EAAO,UAAY,QAAS,CACpE,KAAK,WAAY,EACjB,MAAMD,EAAQ,CAACC,EAAO,MACtB,KAAK,eAAeA,EAAQD,CAAK,CACvC,CACA,CAEE,cAAcI,EAAO,CACnB,MAAO,CAAC,GAAGA,EAAMX,CAAE,EAAE,OAAO,CAAC,EAAE,OAAO,CAACU,EAAKY,IACnCZ,GAAM,CAACY,EAAG,MAChB,CAAC,CACR,CAEE,eAAed,EAAQD,EAAO,CAC5B,MAAMgB,EAAaf,EAAO,QAAQ,mBAAmB,EAAE,QAAQ,MAAM,EAC/DgB,EAAUhB,EAAO,QAAQ,YAAY,EAAE,QAAQ,OACrDN,EAAK,uBAAwB,CAAE,WAAAqB,EAAY,QAAAC,EAAS,MAAAjB,EAAO,CAC/D,CAEE,MAAM,cAAcC,EAAQ,EACd,MAAMN,EAAK,kBAAmB,KAAK,WAAWM,CAAM,CAAC,IACxD,KAAK,KACZA,EAAO,QAAQ,MAAM,EAAE,OAAQ,EAC3B,KAAK,KAAK,OAAS,GAAG,KAAK,cAAe,EAC9C,KAAK,WAAY,EAEvB,CAEE,eAAgB,CACd,KAAK,UAAU,UAAY,GAC3B,KAAK,eAAe,UAAU,OAAO,MAAM,EAC3C,KAAK,WAAW,UAAU,IAAI,MAAM,CACxC,CAMA"}