import{e as C,$ as x,q as l,g as m,i as _,j as g,k as T,l as f,p as b,m as L}from"./constants-D6t7YzCi.js";import k from"./modal-B6FqJAZv.js";import{s as v}from"./shippableUnitsTable-C_znsOA6.js";class E{constructor(){let t={get_cookie:function(s){let i=document.cookie.match("(^|;) ?"+s+"=([^;]*)(;|$)");return i?unescape(i[2]):null},delete_cookie:function(s){let i=new Date;i.setTime(i.getTime()-1),document.cookie=s+="=; expires="+i.toGMTString()},set_cookie:function(s,i,a,n,c,o,u,p){let r=s+"="+escape(i);if(a){let h=new Date(a,n,c);r+="; expires="+h.toGMTString()}o&&(r+="; path="+escape(o)),u&&(r+="; domain="+escape(u)),p&&(r+="; secure"),document.cookie=r}},e={get:(s,i)=>i in s?s[i]:t.get_cookie(i),set:(s,i,a)=>a?t.set_cookie(i,a):t.delete_cookie(i)};this.cookie=new Proxy(t,e)}}let y=class{constructor(){this.title="Заголовок",this.submitText="OK",this.footer=[],this.content=[],this.fields=[]}};class S extends y{constructor(){super(),this.title="Заказ принят в обработку",this.submitText="Успешно"}setFooter(){this.footer.push(new C().tag("div").attr("id","submit").attr("class","button").text("ok").get())}setContent(){this.content.push(new C().tag("div").attr("class","text").text("Какое-то сообщение").get())}}class q{constructor(t){const{_type:e,_className:s,_hidden:i,_required:a,_name:n,_autocomplete:c,_pattern:o,_badgeWidth:u,_id:p,_placeholder:r,_errorEl:h}=t;return this.container=document.createElement("div"),this.container.classList.add("input-container"),this.input=document.createElement("input"),e&&(this.input.type=e),this.input.placeholder=" ",s&&this.input.classList.add(s),i&&(this.input.hidden=i),a&&(this.input.required=a),c&&(this.input.autocomplete=c),n&&(this.input.name=n),o&&(this.input.pattern=o),this.input.id=p,this.labelBadge=document.createElement("div"),this.labelBadge.classList.add("badge"),this.labelBadge.style.width=u,this.label=document.createElement("label"),this.label.innerText=r,this.label.htmlFor=p,this.container.append(this.input),this.container.append(this.labelBadge),this.container.append(this.label),h&&this.container.append(h),this.container}}class w{constructor(t){this._type="text",this._required=!1,this._badgeWidth="50px",this._id="name",this._placeholder="email",this._autocomplete=!1}id(t){return this._id=t,this}type(t){return this._type=t,this}hidden(){return this._hidden=!0,this}required(){return this._required=!0,this}name(t){return this._name=t,this}autocomplete(){return this._autocomplete=!0,this}placeholder(t){return this._placeholder=t,this}class(t){return this._class=t,this}pattern(t){let e=new RegExp(t);return this._pattern=e.source,this}badgeWidth(t){return this._badgeWidth=t,this}errorEl(t){return this._errorEl=t,this}get(){return new q(this)}}class F extends y{constructor(){super(),this.title="Вход",this.submitText="Войти",this.setFields()}setFields(){let t=new w().id("email").required().name("email").autocomplete().badgeWidth("55px").type("email").placeholder("email").get(),e=new w().id("password").required().name("password").autocomplete().pattern("[a-zA-Z0-9-_()]{6,}").badgeWidth("65px").placeholder("пароль").get();this.fields={email:t,password:e}}}class W extends y{constructor(){super(),this.title="Данные для связи",this.submitText="отправить данные",this.setFields(),this.setFooter()}setFooter(){this.footer.push(new C().tag("div").attr("class","button").text("Отправляя данные, вы соглашаетесь на обработку персональных данных").get())}setFields(){let t=new w().id("name").badgeWidth("150px").required().placeholder("как к Вам обращаться").pattern("[а-яА-Я]{1,}").get(),e=new w().id("phone").badgeWidth("130px").required().placeholder("сотовый для связи").pattern("[0-9-+_()]{6,17}").get(),s=new w().id("company").badgeWidth("175px").required().placeholder("название Вашей компании").pattern("[a-zA-Zа-яА-я\\s()]{3,}").get();this.fields={name:t,phone:e,company:s}}}class B{constructor(){let t=x(".user-content .cart .content").first();t&&(this.container=t,t.onclick=this.handleClick.bind(this),t.onkeyup=this.handleKeyUp.bind(this),this.total=t[l](".total span"),this.$cartEmptyText=t[l](".empty-cart"),this.$cartCount=t[l](".cart .count"),this.rows=t[m](".row"),this.setUrl(),this.mapTables(),this.renderSums(),this.cookie=new E,this.setModals())}renderSums(){const t=[...this.container[m]("[shippable-table]")].reduce((e,s)=>{const i=+s.dataset.price,a=[...s[m]("[unit-row]")].reduce((function(c,o){const u=+o.dataset.multiplier,p=+o[l]("input").value,r=u*i*p,h=o[l](".subSum");return h&&(h[_]=g.format(r)),c+r}).bind(i),0),n=s.closest(".row")[l](".sub-sum");return n[_]=g.format(a),e+a},0);this.total[_]=g.format(t)}mapTables(){[...this.container[m](".shippable-table")].forEach(t=>{new v(t)})}counterCallback(){T("cartDeadline"),this.dropCart()}async dropCart(){var s;const t=f(),e=await b("/cart/drop",{cartToken:t});(s=e==null?void 0:e.arr)!=null&&s.ok&&this.showEmptyCart()}rowUnitIds(t){return[...t[m]("[unit-row]")].map(e=>e.dataset.unitid)}cartRowDTO(t){let e=t.closest(".row");return{sess:f(),product_id:e.dataset.productId,unit_ids:this.rowUnitIds(e)}}async handleClick({target:t}){t.classList.contains("del")?this.renderSums():(t.classList.contains("plus")||t.classList.contains("minus"))&&(this.rowTotalCount(t.closest(".row"))?this.renderSums():this.renderSums())}async handleKeyUp({target:t}){if(t.classList.contains("input")&&t.tagName==="INPUT"){this.renderSums();const e=+t.value;this.updateOrCreate(t,e)}}rowTotalCount(t){return[...t[m]("input")].reduce((e,s)=>e+ +s.value,0)}updateOrCreate(t,e){const s=t.closest("[shippable-table]").dataset["1sid"],i=t.closest("[unit-row]").dataset.unitid;b(this.url+"/updateOrCreate",{product_id:s,unit_id:i,count:e})}async deleteCartRow(t){var s;const e=await b(`${this.url}/deleteRow`,this.cartRowDTO(t));(s=e==null?void 0:e.arr)!=null&&s.ok&&(t.closest(".row").remove(),this.rows.length<1&&this.showEmptyCart(),this.renderSums())}setUrl(){this.url="/adminsc/orderitem",L()&&(this.url="/adminsc/order")}showEmptyCart(){this.container.innerHTML="",this.$cartEmptyText.classList.remove("none"),this.$cartCount.classList.add("none")}setModals(){const t=document[l]("#cartLead"),e=document[l]("#cartLogin"),s=document[l]("#cartSuccess");t&&new k({button:t,data:new W,callback:this.modalLeadCallback.bind(this)}),e&&new k({button:e,data:new F,callback:this.modalLoginCallback.bind(this)}),s&&new k({button:s,data:new S,callback:this.modalcartSuccessCallback.bind(this)})}async modalLeadCallback(t,e){let s=t.name.value,i=t.phone.value,a=t.company.value,n=f(),c=await b("/cart/lead",{name:s,phone:i,company:a,sess:n});e.close(),c&&location.reload()}async modalcartSuccessCallback(t,e){e.close()}async modalLoginCallback(t,e){let s=t.email.value,i=t.password.value,a=f(),n=await b("/cart/login",{email:s,password:i,sess:a});e.close(),n&&location.reload()}}export{B as default};
