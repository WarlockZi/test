{"version":3,"file":"cart-kw7WtBxv.js","sources":["../../src/components/cookie/new/cookie.js","../../src/Cart/cart.js"],"sourcesContent":["export default class Cookie {\r\n  constructor() {\r\n    let _cookie = {\r\n      get_cookie: function (cookie_name) {\r\n        let r = document.cookie.match('(^|;) ?' + cookie_name + '=([^;]*)(;|$)');\r\n        return r ? unescape(r[2]) : null\r\n      },\r\n      delete_cookie: function (cookie_name) {\r\n        let c = new Date();\r\n        c.setTime(c.getTime() - 1);\r\n        document.cookie = cookie_name += \"=; expires=\" + c.toGMTString()\r\n      },\r\n      set_cookie: function (name, value, exp_y, exp_m, exp_d, path, domain, secure) {\r\n        let c = name + \"=\" + escape(value);\r\n        if (exp_y) {\r\n          let expires = new Date(exp_y, exp_m, exp_d);\r\n          c += \"; expires=\" + expires.toGMTString()\r\n        }\r\n        if (path) c += \"; path=\" + escape(path);\r\n        if (domain) c += \"; domain=\" + escape(domain);\r\n        if (secure) c += \"; secure\";\r\n        document.cookie = c;\r\n      }\r\n    };\r\n    let __methods = {\r\n      get: (t, m) => m in t ? t[m] : _cookie.get_cookie(m),\r\n      set: (t, m, v) => v ? _cookie.set_cookie(m, v) : _cookie.delete_cookie(m)\r\n    };\r\n    this.cookie = new Proxy(_cookie, __methods);\r\n  }\r\n\r\n}","import './counter1'\r\nimport {$, cookieRemove, formatter, getPhpSession, post} from '../common'\r\n// import Counter1 from \"./counter1\";\r\nimport Cookie from \"../components/cookie/new/cookie\";\r\nimport {ael, it, qa, qs} from '../constants';\r\nimport shippableTable from \"../share/shippable/shippableUnitsTable\";\r\n\r\nexport default class Cart {\r\n   constructor() {\r\n      this.container = $('.user-content .cart .content').first();\r\n      if (!this.container) return;\r\n\r\n      this.container[ael]('click', this.handleClick.bind(this));\r\n      this.container[ael]('keyup', this.handleKeyUp.bind(this));\r\n      // container[ael]('click', handleShippableUnitsTableClick.bind(this))\r\n\r\n      // this.cartDeadline = this.cartLifeMs + Date.now()\r\n      this.total = this.container[qs]('.total span');\r\n      this.$cartEmptyText = this.container[qs]('.empty-cart');\r\n      this.$cartCount = this.container[qs]('.cart .count');\r\n      this.rows = this.container[qa]('.row');\r\n      this.url = '/cart'\r\n\r\n      this.mapTables()\r\n      this.renderSums()\r\n      this.cookie = new Cookie();\r\n      // this.setCounter()\r\n   }\r\n\r\n   renderSums() {\r\n      const total = [...this.container[qa]('[shippable-table]')]\r\n         .reduce((acc, table) => {\r\n            const price = +table.dataset.price;\r\n            const sum = [...table[qa]('[unit-row]')].reduce(\r\n               function (acc, unitRow) {\r\n                  const multi = +unitRow.dataset.multiplier\r\n                  const count = +unitRow[qs]('input').value\r\n                  const sum = multi * price * count\r\n                  const sub_sum = unitRow[qs]('.subSum')\r\n                  if (sub_sum) sub_sum[it] = formatter.format(sum)\r\n                  return acc + sum\r\n               }.bind(price), 0)\r\n            const tableSum = table.closest('.row')[qs]('.sub-sum')\r\n            tableSum[it] = formatter.format(sum)\r\n            return acc + sum\r\n         }, 0)\r\n      this.total[it] = formatter.format(total)\r\n   }\r\n\r\n   mapTables() {\r\n      [...this.container[qa]('.shippable-table')]\r\n         .forEach((table) => {\r\n            new shippableTable(table)\r\n         })\r\n   }\r\n\r\n   async dropCart() {\r\n      const cartToken = getPhpSession();\r\n      const res = await post('/cart/drop', {cartToken});\r\n      if (res?.arr?.ok) {\r\n         this.showEmptyCart()\r\n      }\r\n   }\r\n\r\n   rowUnitIds(row) {\r\n      return [...row[qa]('[unit-row]')].map((unitRow) => {\r\n         return unitRow.dataset.unitid\r\n      })\r\n   }\r\n\r\n   cartRowDTO(target) {\r\n      const row = target.closest('.row');\r\n      return {\r\n         sess: getPhpSession(),\r\n         product_id: row.dataset.productId,\r\n         unit_ids: this.rowUnitIds(row),\r\n      }\r\n   }\r\n\r\n   async handleClick({target}) {\r\n      if (target.classList.contains('del')) {\r\n         await this.deleteCartRow(target)\r\n         this.renderSums()\r\n      } else if (target.classList.contains('plus') || target.classList.contains('minus')) {\r\n         if (this.rowTotalCount(target.closest('.row'))) {\r\n            this.renderSums()\r\n            // this.changeCount(target)\r\n         } else {\r\n            this.renderSums()\r\n         }\r\n      }\r\n   }\r\n\r\n   async handleKeyUp({target}) {\r\n      if (target.classList.contains('input') && target.tagName === 'INPUT') {\r\n         this.renderSums()\r\n         const count = +target.value\r\n         this.updateOrCreate(target, count)\r\n      }\r\n   }\r\n\r\n   rowTotalCount(table) {\r\n      return [...table[qa]('input')].reduce((acc, el) => {\r\n         return acc + (+el.value)\r\n      }, 0)\r\n   }\r\n\r\n   updateOrCreate(target, count) {\r\n      const product_id = target.closest('[shippable-table]').dataset['1sid'];\r\n      const unit_id = target.closest('[unit-row]').dataset['unitid'];\r\n      post(`${this.url}/updateOrCreate`, {product_id, unit_id, count})\r\n   }\r\n\r\n   async deleteCartRow(target) {\r\n      const res = await post(`${this.url}/deleteRow`, this.cartRowDTO(target));\r\n      if (res?.arr?.ok) {\r\n         target.closest('.row').remove();\r\n         if (this.rows.length < 1) this.showEmptyCart()\r\n         this.renderSums()\r\n      }\r\n   }\r\n\r\n   showEmptyCart() {\r\n      this.container.innerHTML = '';\r\n      this.$cartEmptyText.classList.remove('none')\r\n      this.$cartCount.classList.add('none')\r\n   }\r\n\r\n   counterCallback() {\r\n      cookieRemove('cartDeadline')\r\n      this.dropCart().then()\r\n   }\r\n\r\n}"],"names":["Cookie","_cookie","cookie_name","r","c","name","value","exp_y","exp_m","exp_d","path","domain","secure","expires","__methods","t","m","v","Cart","$","ael","qs","qa","total","acc","table","price","sum","unitRow","multi","count","sub_sum","it","formatter","tableSum","shippableTable","cartToken","getPhpSession","post","row","target","el","product_id","unit_id","cookieRemove"],"mappings":"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"}