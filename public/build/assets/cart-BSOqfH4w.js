import{c as y,h as S,$ as q,i as C,j as g,p as f,k as w,l as I}from"./common-Boy4RmlM.js";import x from"./modal-DAG4M-QV.js";import{a as L,q as c,b as m,i as E}from"./constants-Clh-pk9Y.js";import{s as W}from"./shippableUnitsTable-CxJT_S2e.js";class F{constructor(){let t={get_cookie:function(s){let i=document.cookie.match("(^|;) ?"+s+"=([^;]*)(;|$)");return i?unescape(i[2]):null},delete_cookie:function(s){let i=new Date;i.setTime(i.getTime()-1),document.cookie=s+="=; expires="+i.toGMTString()},set_cookie:function(s,i,a,n,l,o,d,p){let r=s+"="+escape(i);if(a){let u=new Date(a,n,l);r+="; expires="+u.toGMTString()}o&&(r+="; path="+escape(o)),d&&(r+="; domain="+escape(d)),p&&(r+="; secure"),document.cookie=r}},e={get:(s,i)=>i in s?s[i]:t.get_cookie(i),set:(s,i,a)=>a?t.set_cookie(i,a):t.delete_cookie(i)};this.cookie=new Proxy(t,e)}}let T=class{constructor(){this.title="Заголовок",this.submitText="OK",this.footer=[],this.content=[],this.fields=[]}};class $ extends T{constructor(){super(),this.title="Заказ принят в обработку",this.submitText="Успешно"}setFooter(){this.footer.push(new y().tag("div").attr("id","submit").attr("class","button").text("ok").get())}setContent(){this.content.push(new y().tag("div").attr("class","text").text("Какое-то сообщение").get())}}class U{constructor(t){const{_type:e,_onKeyUp:s,_onInput:i,_className:a,_hidden:n,_required:l,_name:o,_autocomplete:d,_pattern:p,_badgeWidth:r,_id:u,_placeholder:v,_errorEl:b}=t;if(this.container=document.createElement("div"),this.container.classList.add("input-container"),this.input=document.createElement("input"),s&&this.input.addEventListener("keyup",s.bind(this)),i&&this.input.addEventListener("input",i.bind(this)),e&&(this.input.type=e),this.input.placeholder=" ",a&&this.input.classList.add(a),n&&(this.input.hidden=n),l&&(this.input.required=l),d&&(this.input.autocomplete=d),o&&(this.input.name=o),p&&(this.input.pattern=p),this.input.id=u,this.labelBadge=document.createElement("div"),this.labelBadge.classList.add("badge"),this.labelBadge.style.width=r,this.label=document.createElement("label"),this.label.innerText=v,this.label.htmlFor=u,this.container.append(this.input),this.container.append(this.labelBadge),this.container.append(this.label),b){if(this.errorEl=new y().tag("div"),b.startsWith("#")){const k=b.replace("#","");this.errorEl=this.errorEl.attr("id",k)}else if(b.startsWith(".")){const k=b.replace(".","");this.errorEl=this.errorEl.attr("class",k)}this.errorEl=this.errorEl.get(),this.container.append(this.errorEl)}return this.container}}class _{constructor(){this._type="text",this._required=!1,this._badgeWidth="50px",this._id="name",this._placeholder="email",this._autocomplete=!1}id(t){return this._id=t,this}type(t){return this._type=t,this}hidden(){return this._hidden=!0,this}required(){return this._required=!0,this}name(t){return this._name=t,this}autocomplete(){return this._autocomplete=!0,this}placeholder(t){return this._placeholder=t,this}class(t){return this._class=t,this}pattern(t){let e=new RegExp(t);return this._pattern=e.source,this}badgeWidth(t){return this._badgeWidth=t,this}errorEl(t){return this._errorEl=t,this}onKeyUp(t){return this._onKeyUp=t,this}onInput(t){return this._onInput=t,this}get(){return new U(this)}}class K extends T{constructor(){super(),this.title="Вход",this.submitText="Войти",this.setFields()}setFields(){const t=new _().id("email").required().name("email").type("text").onInput(this.onInputEmail.bind(this)).errorEl("#emailError").badgeWidth("55px").placeholder("email").get(),e=new _().id("password").required().name("password").type("password").badgeWidth("65px").placeholder("пароль").get();this.fields={email:t,password:e}}onInputEmail({target:t}){const e=t.value,s=S(e);this.fields.email.querySelector("#emailError").innerText=s.length?s[0]:"",this.fields.email.querySelector("input").style.outline=s.length?"solid 1px #dc2f55":"solid 1px #2fdcdb",this.fields.email.querySelector("label").style.color=s.length?"#dc2f55":"#2fdcdb"}}class M extends T{constructor(){super(),this.title="Данные для связи",this.submitText="отправить данные",this.setFields(),this.setFooter()}setFooter(){this.footer.push(new y().tag("div").attr("class","button").text("Отправляя данные, вы соглашаетесь на обработку персональных данных").get())}setFields(){const t=new _().id("name").badgeWidth("150px").required().placeholder("как к Вам обращаться").pattern("[а-яА-Я]{1,}").get(),e=new _().id("phone").badgeWidth("130px").required().placeholder("сотовый для связи").pattern("[0-9-+_()]{6,17}").get(),s=new _().id("company").badgeWidth("175px").required().placeholder("название Вашей компании").pattern("[a-zA-Zа-яА-я\\s()]{3,}").get();this.fields={name:t,phone:e,company:s}}}class P{constructor(){this.container=q(".user-content .cart .content").first(),this.container&&(this.container[L]("click",this.handleClick.bind(this)),this.container[L]("keyup",this.handleKeyUp.bind(this)),this.total=this.container[c](".total span"),this.$cartEmptyText=this.container[c](".empty-cart"),this.$cartCount=this.container[c](".cart .count"),this.rows=this.container[m](".row"),this.url="/cart",this.mapTables(),this.renderSums(),this.cookie=new F,this.setModals())}renderSums(){const t=[...this.container[m]("[shippable-table]")].reduce((e,s)=>{const i=+s.dataset.price,a=[...s[m]("[unit-row]")].reduce(function(l,o){const d=+o.dataset.multiplier,p=+o[c]("input").value,r=d*i*p,u=o[c](".subSum");return u&&(u[E]=C.format(r)),l+r}.bind(i),0),n=s.closest(".row")[c](".sub-sum");return n[E]=C.format(a),e+a},0);this.total[E]=C.format(t)}mapTables(){[...this.container[m](".shippable-table")].forEach(t=>{new W(t)})}async dropCart(){const t=g();(await f("/cart/drop",{cartToken:t}))?.arr?.ok&&this.showEmptyCart()}rowUnitIds(t){return[...t[m]("[unit-row]")].map(e=>e.dataset.unitid)}cartRowDTO(t){const e=t.closest(".row");return{sess:g(),product_id:e.dataset.productId,unit_ids:this.rowUnitIds(e)}}async handleClick({target:t}){t.classList.contains("del")?(await this.deleteCartRow(t),this.renderSums()):(t.classList.contains("plus")||t.classList.contains("minus"))&&(this.rowTotalCount(t.closest(".row"))?(this.renderSums(),this.changeCount(t)):this.renderSums())}changeCount(t){}async handleKeyUp({target:t}){if(t.classList.contains("input")&&t.tagName==="INPUT"){this.renderSums();const e=+t.value;this.updateOrCreate(t,e)}}rowTotalCount(t){return[...t[m]("input")].reduce((e,s)=>e+ +s.value,0)}updateOrCreate(t,e){const s=t.closest("[shippable-table]").dataset["1sid"],i=t.closest("[unit-row]").dataset.unitid;f(`${this.url}/updateOrCreate`,{product_id:s,unit_id:i,count:e})}async deleteCartRow(t){(await f(`${this.url}/deleteRow`,this.cartRowDTO(t)))?.arr?.ok&&(t.closest(".row").remove(),this.rows.length<1&&this.showEmptyCart(),this.renderSums())}showEmptyCart(){this.container.innerHTML="",this.$cartEmptyText.classList.remove("none"),this.$cartCount.classList.add("none")}setModals(){const t=document[c]("#cartLead"),e=document[c]("#cartLogin"),s=document[c]("#cartSuccess");t&&new x({button:t,data:new M,callback:this.modalLeadCallback.bind(this)}),e&&new x({button:e,data:new K,callback:this.modalLoginCallback.bind(this)}),s&&new x({button:s,data:new $,callback:this.modalcartSuccessCallback.bind(this)})}async modalLeadCallback(t,e){const s=w(t.name.value),i=w(t.phone.value),a=w(t.company.value),n=g(),l=await f("/cart/lead",{name:s,phone:i,company:a,sess:n});e.close(),l&&location.reload()}async modalcartSuccessCallback(t,e){e.close()}async modalLoginCallback(t,e){const s=w(t.email.value),i=w(t.password.value),a=g(),n=await f("/cart/login",{email:s,password:i,sess:a});e.close(),n&&location.reload()}counterCallback(){I("cartDeadline"),this.dropCart().then()}}export{P as default};
