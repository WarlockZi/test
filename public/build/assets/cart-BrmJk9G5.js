import{c as a,h as y,i as _,p as f,j as x,$ as I,k,l as B}from"./common-DxHL9myf.js";import R from"./modal-CFaqzGnW.js";import{a as v,q as p,b as g,i as L}from"./constants-D_Ps4z6O.js";import{s as T}from"./shippableUnitsTable-B73e7E0p.js";class S{constructor(){let t={get_cookie:function(s){let i=document.cookie.match("(^|;) ?"+s+"=([^;]*)(;|$)");return i?unescape(i[2]):null},delete_cookie:function(s){let i=new Date;i.setTime(i.getTime()-1),document.cookie=s+="=; expires="+i.toGMTString()},set_cookie:function(s,i,n,l,u,o,c,d){let r=s+"="+escape(i);if(n){let h=new Date(n,l,u);r+="; expires="+h.toGMTString()}o&&(r+="; path="+escape(o)),c&&(r+="; domain="+escape(c)),d&&(r+="; secure"),document.cookie=r}},e={get:(s,i)=>i in s?s[i]:t.get_cookie(i),set:(s,i,n)=>n?t.set_cookie(i,n):t.delete_cookie(i)};this.cookie=new Proxy(t,e)}}class q{constructor(t){const{_type:e,_onKeyUp:s,_onInput:i,_className:n,_hidden:l,_required:u,_name:o,_autocomplete:c,_pattern:d,_badgeWidth:r,_id:h,_placeholder:C,_errorEl:m}=t;if(this.container=new a().tag("div").attr("class","input-container").get(),this.input=document.createElement("input"),s&&this.input.addEventListener("keyup",s.bind(this)),i&&this.input.addEventListener("input",i.bind(this)),e&&(this.input.type=e,e==="password"&&this.showPass()),this.input.placeholder=" ",n&&this.input.classList.add(n),l&&(this.input.hidden=l),u&&(this.input.required=u),c&&(this.input.autocomplete=c),o&&(this.input.name=o),d&&(this.input.pattern=d),this.input.id=h,this.labelBadge=new a().tag("div").attr("class","badge").get(),this.labelBadge.style.width=r,this.label=new a().tag("label").text(C).get(),this.label.htmlFor=h,this.container.append(this.input),this.container.append(this.labelBadge),this.container.append(this.label),m){if(this.errorEl=new a().tag("div"),m.startsWith("#")){const b=m.replace("#","");this.errorEl=this.errorEl.attr("id",b)}else if(m.startsWith(".")){const b=m.replace(".","");this.errorEl=this.errorEl.attr("class",b)}this.errorEl=this.errorEl.get(),this.container.append(this.errorEl)}return this.container}showPass(){const t=new a().tag("span").attr("class","password-control").get();t.addEventListener("click",function({target:e}){e.parentNode.querySelector("input").type=e.parentNode.querySelector("input").type==="password"?"text":"password",e.classList.toggle("view")}),this.container.append(t)}}class E{constructor(){this._type="text"}id(t){return this._id=t,this}type(t){return this._type=t,this}hidden(){return this._hidden=!0,this}required(){return this._required=!0,this}name(t){return this._name=t,this}autocomplete(){return this._autocomplete=!0,this}placeholder(t){return this._placeholder=t,this}class(t){return this._class=t,this}pattern(t){let e=new RegExp(t);return this._pattern=e.source,this}badgeWidth(t){return this._badgeWidth=t,this}errorEl(t){return this._errorEl=t,this}onKeyUp(t){return this._onKeyUp=t,this}onInput(t){return this._onInput=t,this}get(){return new q(this)}}class P{constructor(){return{1:[this.getLoginRows()],2:[this.getRegisterRows()],3:[this.getForgotRows()]}}getLoginRows(){return["Вход",this.getEmailInput(),this.getPasswordInput(),this.getLoginButton(),this.createLinks("login"),this.getLoginWarning()]}getRegisterRows(){return["Регистрация",this.getEmailInput(),this.getPasswordInput(),this.getPhoneInput(),this.getRegisterButton(),this.createLinks("register"),this.getLoginWarning()]}getForgotRows(){return["Восстановление пароля",this.getEmailInput(),this.getForgotButton(),this.createLinks("forgot"),this.getLoginWarning()]}getEmailInput(){return new E().id("email").required().name("email").type("text").onInput(this.onInputEmail.bind(this)).errorEl("#emailError").badgeWidth("55px").placeholder("email").get()}getPasswordInput(){return new E().id("password").required().name("password").type("password").badgeWidth("65px").placeholder("пароль").get()}getPhoneInput(){return new E().id("phone").required().name("phone").type("text").badgeWidth("65px").placeholder("телефон").get()}getLoginButton(){const t=this.createButton("Войти");return t.addEventListener("click",this.login.bind(this)),t}getRegisterButton(){const t=this.createButton("Регистрация");return t.addEventListener("click",this.register.bind(this)),t}getForgotButton(){const t=this.createButton("Забыл пароль");return t.addEventListener("click",this.forgot.bind(this)),t}getLoginLink(){const t=this.createLink("Войти",1);return t.addEventListener("click",this.switch.bind(this)),t}getRegisterLink(){const t=this.createLink("Регистрация",2);return t.addEventListener("click",this.switch.bind(this)),t}getForgotLink(){const t=this.createLink("Забыл пароль",3);return t.addEventListener("click",this.switch.bind(this)),t}getLoginWarning(){return new a().tag("p").text("Оставляя свои данные, вы соглашаетесь с политикой конфиденциальности").get()}createLink(t,e){return new a().tag("div").attr("class","link").attr("data-target",e).text(t).get()}createLinks(t){const e=new a().tag("div").attr("class","row").get();return t==="register"?(e.appendChild(this.getLoginLink()),e.appendChild(this.getForgotLink())):t==="login"?(e.appendChild(this.getRegisterLink()),e.appendChild(this.getForgotLink())):t==="forgot"&&(e.appendChild(this.getLoginLink()),e.appendChild(this.getRegisterLink())),e}switch({target:t},e){const s=new Event("modal.switch",{bubbles:!0});t.dispatchEvent(s)}createButton(t){return new a().tag("button").attr("type","submit").attr("class","button").attr("id","forgot").text(t).get()}async login({target:t}){const e=y(fields.email.value),s=y(fields.password.value),i=_();await f("/cart/login",{email:e,password:s,sess:i})&&location.reload()}async register({target:t}){}async forgot({target:t}){}onInputEmail({target:t}){const e=t.closest(".input-container"),s=t.value,i=x(s);e.querySelector("#emailError").innerText=i.length?i[0]:"",e.querySelector("label").style.color=i.length?"#dc2f55":"#2fdcdb",t.style.outline=i.length?"solid 1px #dc2f55":"solid 1px #2fdcdb"}}class M{constructor(){this.container=I(".user-content .cart .content").first(),this.container&&(this.container[v]("click",this.handleClick.bind(this)),this.container[v]("keyup",this.handleKeyUp.bind(this)),this.total=this.container[p](".total span"),this.$cartEmptyText=this.container[p](".empty-cart"),this.$cartCount=this.container[p](".cart .count"),this.rows=this.container[g](".row"),this.url="/cart",this.mapTables(),this.renderSums(),this.cookie=new S,this.setModals())}renderSums(){const t=[...this.container[g]("[shippable-table]")].reduce((e,s)=>{const i=+s.dataset.price,n=[...s[g]("[unit-row]")].reduce(function(u,o){const c=+o.dataset.multiplier,d=+o[p]("input").value,r=c*i*d,h=o[p](".subSum");return h&&(h[L]=k.format(r)),u+r}.bind(i),0),l=s.closest(".row")[p](".sub-sum");return l[L]=k.format(n),e+n},0);this.total[L]=k.format(t)}mapTables(){[...this.container[g](".shippable-table")].forEach(t=>{new T(t)})}async dropCart(){const t=_();(await f("/cart/drop",{cartToken:t}))?.arr?.ok&&this.showEmptyCart()}rowUnitIds(t){return[...t[g]("[unit-row]")].map(e=>e.dataset.unitid)}cartRowDTO(t){const e=t.closest(".row");return{sess:_(),product_id:e.dataset.productId,unit_ids:this.rowUnitIds(e)}}async handleClick({target:t}){t.classList.contains("del")?(await this.deleteCartRow(t),this.renderSums()):(t.classList.contains("plus")||t.classList.contains("minus"))&&(this.rowTotalCount(t.closest(".row"))?this.renderSums():this.renderSums())}async handleKeyUp({target:t}){if(t.classList.contains("input")&&t.tagName==="INPUT"){this.renderSums();const e=+t.value;this.updateOrCreate(t,e)}}rowTotalCount(t){return[...t[g]("input")].reduce((e,s)=>e+ +s.value,0)}updateOrCreate(t,e){const s=t.closest("[shippable-table]").dataset["1sid"],i=t.closest("[unit-row]").dataset.unitid;f(`${this.url}/updateOrCreate`,{product_id:s,unit_id:i,count:e})}async deleteCartRow(t){(await f(`${this.url}/deleteRow`,this.cartRowDTO(t)))?.arr?.ok&&(t.closest(".row").remove(),this.rows.length<1&&this.showEmptyCart(),this.renderSums())}showEmptyCart(){this.container.innerHTML="",this.$cartEmptyText.classList.remove("none"),this.$cartCount.classList.add("none")}setModals(){new R({triggers:[".guest-menu","#cartLogin"],boxes:new P})}counterCallback(){B("cartDeadline"),this.dropCart().then()}}export{M as default};
