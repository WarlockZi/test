import{e as a,$ as l,p as n}from"./constants-mwD5SO1c.js";class o{constructor(e){var t;if(e)return this.ul=new a().tag("ul").attr("class","options").get(),this.label=new a().tag("span").get(),this.options=this.getFormattedOptions(e.querySelectorAll("option")),this.space=new a().tag("div").attr("class","space").text((t=this==null?void 0:this.selectedOption)==null?void 0:t.label).get(),this.arrow=new a().tag("div").attr("class","arrow").get(),this.sel=this.createSelectTag(e),e.after(this.sel),this.label.append(this.space),this.label.append(this.arrow),this.sel.append(this.label),this.sel.append(this.ul),e.remove(),this.ul.addEventListener("click",this.handleUlClick.bind(this)),this.label.addEventListener("click",this.handleLabelClick.bind(this)),this.sel.addEventListener("blur",this.handleSelectBlur.bind(this)),this.sel.addEventListener("keydown",this.handleSelectKeydown.bind(this)),this}getFormattedOptions(e){return[...e].map(t=>{const s=new a().tag("li").text(t.label).attr("data-value",t.value).get();return t.selected&&s.classList.add("selected"),this.ul.append(s),{value:t.value,label:t.label,selected:t.selected,element:s,option:t}})}createSelectTag(e){var s;const t=new a().tag("div").className(e==null?void 0:e.className).field(e.dataset.field).attr("select-new","").attr("data-value",((s=this==null?void 0:this.selectedOption)==null?void 0:s.value)??"").attr("tabindex","0");return e.hasAttribute("data-field")&&t.attr("data-field",e.dataset.field),e.hasAttribute("data-relation")&&t.attr("data-relation",e.dataset.relation),t.get()}handleSelectBlur(){this.ul.classList.remove("show")}handleLabelClick(){this.ul.classList.toggle("show")}handleUlClick({target:e}){e.classList.add("selected"),this.selectedOption.element.classList.remove("selected"),this.selectValue(e.dataset.value),this.ul.classList.remove("show")}onchange(e){this.callback=e}handleSelectKeydown(e){let t,s="";if(e.code==="Space")select.ul.classList.toggle("show");else if(e.code==="ArrowUp"){const i=select.options[select.selectedOptionIndex-1];i&&select.selectValue(i.value)}else if(e.code==="ArrowDown"){const i=select.options[select.selectedOptionIndex+1];i&&select.selectValue(i.value)}else if(e.code==="Enter"||e.code==="Escape")select.ul.classList.remove("show");else{clearTimeout(t),s+=e.key,t=setTimeout(()=>{s=""},500);const i=this.options.find(c=>c.label.toLowerCase().includes(s));i&&this.sel.selectValue(i.value)}}get selectedOption(){return this.options.find(e=>e.selected)}get selectedOptionIndex(){return this.options.indexOf(this.selectedOption)}selectValue(e){const t=this.options.find(i=>i.value===e),s=this.selectedOption;s.selected=!1,t.selected=!0,this.space.innerText=t.label,this.sel.dataset.value=t.value,s.element.classList.remove("selected"),t.element.classList.add("selected"),t.element.scrollIntoView({block:"nearest"}),this.sel.dispatchEvent(new CustomEvent("customSelect.changed",{bubbles:!0,detail:{next:t,prev:s,target:this.sel}}))}}class r{constructor(){this.$promotion=l(".promotion-edit").first(),this.$promotion&&(this.updateUrl="/adminsc/promotion/updateOrCreate",this.id=l(this.$promotion).find("[data-field='id']").innerText,this.$count=l("[data-field='count']").first(),this.$unit=l("[select-new].unit").first(),new o(this.$unit),l('[data-field="unit"]').first().addEventListener("customSelect.changed",this.unitChanged.bind(this)),this.$newPrice=l('[data-field="new_price"]').first(),this.$activeTill=l("[data-field='active-till']").first(),this.$activeTill.addEventListener("change",this.activetillChanged.bind(this)))}unitChanged(e){let t=this.dto(this);t.unit_id=e.detail.next.value,n(this.updateUrl,t)}async activetillChanged({target:e}){let t=this.dto(this);t.active_till=e.value,await n(this.updateUrl,t)}dto(e){return{id:this.id}}}const u=Object.freeze(Object.defineProperty({__proto__:null,default:r},Symbol.toStringTag,{value:"Module"}));export{r as P,o as S,u as a};
