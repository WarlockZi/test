{"version":3,"file":"shippableUnitsTable-BYLgyXEL.js","sources":["../../src/components/shippable/shippableUnitsTable.js"],"sourcesContent":["import { post } from \"../../common\";\r\nimport { ael, qa, qs } from \"../../constants\";\r\n\r\nexport default class shippableTable {\r\n  constructor(table) {\r\n    if (!table) return false;\r\n\r\n    this.table = table;\r\n    this.table[ael](\"click\", this.handleClick.bind(this));\r\n\r\n    this.blueButton = this.table[qs](\".blue-button\") ?? null;\r\n    this.greenButtonWrap = this.table[qs](\".green-button-wrap\") ?? null;\r\n\r\n    this.price = +this.table.dataset.price;\r\n    this.sid = this.table.dataset[\"1sid\"];\r\n    this.total = this.table[qs](\"[data-total]\");\r\n    this.updateOrCreateUrl = this.table[qs](\"[data-total]\");\r\n    this.setFormatter();\r\n    this.showButtons();\r\n    this.renderSums();\r\n  }\r\n\r\n  showButtons() {\r\n    if (!this.blueButton || !this.greenButtonWrap) return false;\r\n    if (this.getTotalCount()) {\r\n      this.blueButton.style.display = \"none\";\r\n      this.greenButtonWrap.style.display = \"flex\";\r\n    } else {\r\n      this.blueButton.style.display = \"flex\";\r\n      this.greenButtonWrap.style.display = \"none\";\r\n    }\r\n  }\r\n\r\n  handleClick({ target }) {\r\n    const targ = target ?? this.table;\r\n    if (targ.classList.contains(\"blue-button\")) {\r\n      this.showGreenButton(targ);\r\n    } else if (targ.classList.contains(\"green-button\")) {\r\n      window.location.href = \"/cart\";\r\n    } else if (targ.classList.contains(\"plus\")) {\r\n      const row = targ.closest(\".unit-row\");\r\n      this.increment(row);\r\n    } else if (targ.classList.contains(\"minus\")) {\r\n      const row = targ.closest(\".unit-row\");\r\n      this.decrement(row);\r\n    }\r\n  }\r\n\r\n  increment(row) {\r\n    row[qs](\"input\").value++;\r\n    row.dataset.rowSum = \"\" + row[qs](\"input\").value;\r\n    this.handleChange(row);\r\n  }\r\n\r\n  decrement(row) {\r\n    const input = row[qs](\"input\");\r\n    const count = +input.value;\r\n    if (count < 2) {\r\n      input.value = \"0\";\r\n    } else {\r\n      input.value--;\r\n      row.dataset.rowSum = input.value;\r\n    }\r\n    this.handleChange(row);\r\n  }\r\n\r\n  getTotalCount() {\r\n    return [...this.table[qa](\"input\")].reduce((acc, el) => {\r\n      return acc + +el.value;\r\n    }, 0);\r\n  }\r\n\r\n  handleChange(row) {\r\n    const count = this.getTotalCount(row);\r\n    this.renderSums();\r\n    if (count === 0) {\r\n      this.showBlueButton();\r\n      this.toServer(this.dto(row));\r\n    } else {\r\n      this.toServer(this.dto(row));\r\n    }\r\n  }\r\n\r\n  renderSums() {\r\n    let total = [...this.table[qa](\".unit-row\")].reduce((acc, row, i) => {\r\n      const rowDto = this.rowDto(row);\r\n      let sub_sum = +this.price * +rowDto.multiplier * +rowDto.count;\r\n      if (rowDto.sub_sum)\r\n        rowDto.sub_sum.innerText = this.formatter.format(sub_sum);\r\n      return acc + sub_sum;\r\n    }, 0);\r\n\r\n    if (this.total) {\r\n      this.total.innerText = this.formatter.format(total);\r\n    }\r\n  }\r\n\r\n  showBlueButton() {\r\n    if (!this.blueButton) return false;\r\n    if (!this.getTotalCount()) {\r\n      this.greenButtonWrap.style.display = \"none\";\r\n      this.greenButtonWrap[qs](\"input\").value = \"\" + 0;\r\n      this.blueButton.style.display = \"flex\";\r\n      this.deleteOrderItems(this.tableDTO(this.table));\r\n    }\r\n  }\r\n\r\n  showGreenButton() {\r\n    if (!this.greenButtonWrap) return false;\r\n    window.YM(\"tovar_v_korzine\");\r\n    this.greenButtonWrap.style.display = \"flex\";\r\n    const count = +this.greenButtonWrap[qs](\"input\").value;\r\n    this.greenButtonWrap[qs](\"input\").value = count ? count : 1;\r\n    this.renderSums();\r\n    this.blueButton.style.display = \"none\";\r\n    this.toServer(this.dto(this.greenButtonWrap[qs](\"[unit-row]\")));\r\n  }\r\n\r\n  deleteOrderItems(tableDTO) {\r\n    post(`/cart/delete`, tableDTO);\r\n  }\r\n\r\n  async toServer(dto) {\r\n    const res = await post(`/cart/updateOrCreate`, dto);\r\n  }\r\n\r\n  setFormatter() {\r\n    this.formatter = new Intl.NumberFormat(\"ru\", {\r\n      style: \"currency\",\r\n      currency: \"RUB\",\r\n      minimumFractionDigits: 2,\r\n    });\r\n  }\r\n\r\n  rowDto(row) {\r\n    return {\r\n      count: row[qs](\"input\").value,\r\n      multiplier: row.dataset.multiplier,\r\n      sub_sum: row[qs](\".sub-sum\"),\r\n      sess_id: localStorage.getItem(\"SESSION\"),\r\n    };\r\n  }\r\n\r\n  tableDTO(table) {\r\n    return {\r\n      unit_ids: this.unitIds(table),\r\n      product_id: this.sid,\r\n    };\r\n  }\r\n\r\n  unitIds(table) {\r\n    return [...table[qa](\"[unit-row]\")].map((unitRow) => {\r\n      return unitRow.dataset.unitid;\r\n    });\r\n  }\r\n\r\n  dto(row) {\r\n    return {\r\n      count: row[qs](\"input\").value,\r\n      unit_id: row.dataset.unitid,\r\n      product_id: this.sid,\r\n      loc_storage_cart_id: localStorage.getItem(\"loc_storage_cart_id\"),\r\n    };\r\n  }\r\n}\r\n"],"names":["shippableTable","table","ael","qs","target","targ","row","input","qa","acc","el","count","total","i","rowDto","sub_sum","tableDTO","post","dto","unitRow"],"mappings":"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"}