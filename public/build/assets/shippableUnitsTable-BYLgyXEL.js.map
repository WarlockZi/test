{"version":3,"file":"shippableUnitsTable-BYLgyXEL.js","sources":["../../src/components/shippable/shippableUnitsTable.js"],"sourcesContent":["import { post } from \"../../common\";\nimport { ael, qa, qs } from \"../../constants\";\n\nexport default class shippableTable {\n  constructor(table) {\n    if (!table) return false;\n\n    this.table = table;\n    this.table[ael](\"click\", this.handleClick.bind(this));\n\n    this.blueButton = this.table[qs](\".blue-button\") ?? null;\n    this.greenButtonWrap = this.table[qs](\".green-button-wrap\") ?? null;\n\n    this.price = +this.table.dataset.price;\n    this.sid = this.table.dataset[\"1sid\"];\n    this.total = this.table[qs](\"[data-total]\");\n    this.updateOrCreateUrl = this.table[qs](\"[data-total]\");\n    this.setFormatter();\n    this.showButtons();\n    this.renderSums();\n  }\n\n  showButtons() {\n    if (!this.blueButton || !this.greenButtonWrap) return false;\n    if (this.getTotalCount()) {\n      this.blueButton.style.display = \"none\";\n      this.greenButtonWrap.style.display = \"flex\";\n    } else {\n      this.blueButton.style.display = \"flex\";\n      this.greenButtonWrap.style.display = \"none\";\n    }\n  }\n\n  handleClick({ target }) {\n    const targ = target ?? this.table;\n    if (targ.classList.contains(\"blue-button\")) {\n      this.showGreenButton(targ);\n    } else if (targ.classList.contains(\"green-button\")) {\n      window.location.href = \"/cart\";\n    } else if (targ.classList.contains(\"plus\")) {\n      const row = targ.closest(\".unit-row\");\n      this.increment(row);\n    } else if (targ.classList.contains(\"minus\")) {\n      const row = targ.closest(\".unit-row\");\n      this.decrement(row);\n    }\n  }\n\n  increment(row) {\n    row[qs](\"input\").value++;\n    row.dataset.rowSum = \"\" + row[qs](\"input\").value;\n    this.handleChange(row);\n  }\n\n  decrement(row) {\n    const input = row[qs](\"input\");\n    const count = +input.value;\n    if (count < 2) {\n      input.value = \"0\";\n    } else {\n      input.value--;\n      row.dataset.rowSum = input.value;\n    }\n    this.handleChange(row);\n  }\n\n  getTotalCount() {\n    return [...this.table[qa](\"input\")].reduce((acc, el) => {\n      return acc + +el.value;\n    }, 0);\n  }\n\n  handleChange(row) {\n    const count = this.getTotalCount(row);\n    this.renderSums();\n    if (count === 0) {\n      this.showBlueButton();\n      this.toServer(this.dto(row));\n    } else {\n      this.toServer(this.dto(row));\n    }\n  }\n\n  renderSums() {\n    let total = [...this.table[qa](\".unit-row\")].reduce((acc, row, i) => {\n      const rowDto = this.rowDto(row);\n      let sub_sum = +this.price * +rowDto.multiplier * +rowDto.count;\n      if (rowDto.sub_sum)\n        rowDto.sub_sum.innerText = this.formatter.format(sub_sum);\n      return acc + sub_sum;\n    }, 0);\n\n    if (this.total) {\n      this.total.innerText = this.formatter.format(total);\n    }\n  }\n\n  showBlueButton() {\n    if (!this.blueButton) return false;\n    if (!this.getTotalCount()) {\n      this.greenButtonWrap.style.display = \"none\";\n      this.greenButtonWrap[qs](\"input\").value = \"\" + 0;\n      this.blueButton.style.display = \"flex\";\n      this.deleteOrderItems(this.tableDTO(this.table));\n    }\n  }\n\n  showGreenButton() {\n    if (!this.greenButtonWrap) return false;\n    window.YM(\"tovar_v_korzine\");\n    this.greenButtonWrap.style.display = \"flex\";\n    const count = +this.greenButtonWrap[qs](\"input\").value;\n    this.greenButtonWrap[qs](\"input\").value = count ? count : 1;\n    this.renderSums();\n    this.blueButton.style.display = \"none\";\n    this.toServer(this.dto(this.greenButtonWrap[qs](\"[unit-row]\")));\n  }\n\n  deleteOrderItems(tableDTO) {\n    post(`/cart/delete`, tableDTO);\n  }\n\n  async toServer(dto) {\n    const res = await post(`/cart/updateOrCreate`, dto);\n  }\n\n  setFormatter() {\n    this.formatter = new Intl.NumberFormat(\"ru\", {\n      style: \"currency\",\n      currency: \"RUB\",\n      minimumFractionDigits: 2,\n    });\n  }\n\n  rowDto(row) {\n    return {\n      count: row[qs](\"input\").value,\n      multiplier: row.dataset.multiplier,\n      sub_sum: row[qs](\".sub-sum\"),\n      sess_id: localStorage.getItem(\"SESSION\"),\n    };\n  }\n\n  tableDTO(table) {\n    return {\n      unit_ids: this.unitIds(table),\n      product_id: this.sid,\n    };\n  }\n\n  unitIds(table) {\n    return [...table[qa](\"[unit-row]\")].map((unitRow) => {\n      return unitRow.dataset.unitid;\n    });\n  }\n\n  dto(row) {\n    return {\n      count: row[qs](\"input\").value,\n      unit_id: row.dataset.unitid,\n      product_id: this.sid,\n      loc_storage_cart_id: localStorage.getItem(\"loc_storage_cart_id\"),\n    };\n  }\n}\n"],"names":["shippableTable","table","ael","qs","target","targ","row","input","qa","acc","el","count","total","i","rowDto","sub_sum","tableDTO","post","dto","unitRow"],"mappings":"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"}