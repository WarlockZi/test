import{$ as y,a as p,q as e,b as r,g as m,p as n,u as c,v as u}from"./search-CxgNiI2j.js";import{s as T}from"./shippableUnitsTable-VzyoRnq_.js";class L{constructor(){this.container=y(".user-content .cart .content").first(),this.container&&(this.container[p]("click",this.handleClick.bind(this)),this.container[p]("keyup",this.handleKeyUp.bind(this)),this.total=this.container[e](".total span"),this.$cartEmptyText=this.container[e](".empty-cart"),this.$cartCount=this.container[e](".cart .count"),this.rows=this.container[r](".row"),this.mapTables(),this.renderSums())}async submitCart(){const t=[].map.call(this.rows,s=>this.cartRowDTO(s));t.sess=m(),n("/cart/submit",t)}rowUnits(t){const s={};return[...t[r]("[unit-row]")].map(a=>{const i=a.dataset.unitid;s[i]=a[e]("input").value}),s}cartRowDTO(t){const s=t.closest(".row");return{product_id:s.dataset.productId,units:this.rowUnits(s)}}renderSums(){const t=[...this.container[r]("[shippable-table]")].reduce((s,a)=>{const i=+a.dataset.price,l=[...a[r]("[unit-row]")].reduce(function(b,o){const f=+o.dataset.multiplier,C=+o[e]("input").value,h=f*i*C,d=o[e](".subSum");return d&&(d[c]=u.format(h)),b+h}.bind(i),0),w=a.closest(".row")[e](".sub-sum");return w[c]=u.format(l),s+l},0);this.total[c]=u.format(t)}mapTables(){[...this.container[r](".shippable-table")].forEach(t=>{new T(t)})}async dropCart(){const t=m();(await n("/cart/drop",{cartToken:t}))?.arr?.ok&&this.showEmptyCart()}async handleClick({target:t}){t.classList.contains("del")?(await this.deleteCartRow(t),this.renderSums()):t.classList.contains("plus")||t.classList.contains("minus")?this.rowTotalCount(t.closest(".row"))?this.renderSums():this.renderSums():t.id==="cartSubmit"&&(YM("cart_submitted"),this.submitCart())}async handleKeyUp({target:t}){if(t.classList.contains("input")&&t.tagName==="INPUT"){this.renderSums();const s=+t.value;this.updateOrCreate(t,s)}}rowTotalCount(t){return[...t[r]("input")].reduce((s,a)=>s+ +a.value,0)}updateOrCreate(t,s){const a=t.closest("[shippable-table]").dataset["1sid"],i=t.closest("[unit-row]").dataset.unitid;n("/cart/updateOrCreate",{product_id:a,unit_id:i,count:s})}async deleteCartRow(t){(await n("/cart/deleteRow",this.cartRowDTO(t)))?.arr?.ok&&(t.closest(".row").remove(),this.rows.length<1&&this.showEmptyCart(),this.renderSums())}showEmptyCart(){this.container.innerHTML="",this.$cartEmptyText.classList.remove("none"),this.$cartCount.classList.add("none")}}export{L as default};
//# sourceMappingURL=Cart-RFnAV_V3.js.map
