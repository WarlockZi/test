"use strict";(self.webpackChunkmy_webpack_project=self.webpackChunkmy_webpack_project||[]).push([[847],{847:(t,i,a)=>{a.d(i,{default:()=>c});var s=a(448),d=a(69),n=a(832);(0,s.$)(".units").first()&&new class{constructor(t){this.$table=(0,s.$)(t).first(),this.$table&&(this.product1sId=(0,s.$)("[data-field='1s_id']").first().innerText,this.$baseUnit=(0,s.$)("[data-field='base_unit']").first(),this.$addUnit=(0,s.$)(".add-unit").first(),this.$rows=(0,s.$)(".rows").first(),this.$emtyRow=(0,s.$)(this.$rows).find(".none"),this.$addUnit.onclick=this.createRow.bind(this),this.$rows.onchange=this.handleChange.bind(this),this.$rows.onkeyup=this.handleKeyUp.bind(this),this.$rows.onclick=this.clickRow.bind(this),this.$rows.addEventListener("customSelect.changed",this.unitChanged.bind(this)),this.initSelects(),setTimeout(this.deleteSelected.bind(this),800))}initSelects(){this.$rows.querySelectorAll("[select-new]").forEach((t=>{new d.A(t)}))}deleteSelected(){let t=this.$rows.querySelectorAll(".selected");t=Array.from(t).map((t=>{if(+t.dataset.value)return t.dataset.value})),this.$table.querySelectorAll("[custom-select]").forEach((function(e){e.querySelectorAll("li").forEach((function(e){t.includes(e.dataset.value)&&e.remove()}))}))}createSelect(t){const e=(new s.n).tag("select").attr("new-select").className("name").get();return[...t[n.qa]("li")].map((t=>{const i=(new s.n).tag("option").attr("value",t.dataset.value).text(t[n.it]).get();e.append(i)})),e}createRow(){let t=this.$baseUnit.selectedOptions[0].innerText,e=(new s.n).tag("div").attr("class","row").get();const i=this.createSelect(this.$emtyRow);let a=(new s.n).attr("type","number").tag("input").attr("value",10).className("multiplier").get(),n=(new s.n).tag("div").attr("class","base-unit").text(t).get(),r=(new s.n).tag("div").className("shippable").get(),l=(new s.n).tag("input").attr("type","checkbox").get(),c=(new s.n).tag("div").attr("class","del").text("X").get();e.append(i),e.append(a),e.append(n),r.append(l),e.append(r),e.append(c),new d.A(i),this.$rows.append(e)}async unitChanged(t){let e=this.dto(t.target.closest(".row"));e.morphed.new_id=t.detail.next.value,e.morphed.old_id=t.detail.prev.value,t.detail.next.value&&this.deleteSelectedUnitFromSelects(t.detail.next.value),t.detail.prev.value&&this.addDeletedUnitToSelects(t.detail.prev),await(0,s.bE)("/adminsc/product/changeUnit",e)}deleteSelectedUnitFromSelects(t){this.$table.querySelectorAll("[custom-select]").forEach((function(e){e.querySelectorAll("li").forEach((function(e){e.dataset.value===t&&e.remove()}))}))}addDeletedUnitToSelects(){this.$table.querySelectorAll("[custom-select]").forEach((function(t){t.querySelectorAll("li").forEach((function(t){t.dataset.value===value&&t.remove()}))}))}async clickRow({target:t}){if(t.classList.contains("del")){let e=t.closest(".row"),i=this.dto(e),a=await(0,s.bE)("/adminsc/product/deleteUnit",i);a?.arr?.ok&&e.remove()}}handleKeyUp(t){let e=+t.target.value;/\d+/.test(e)&&this.update(t,this)}async handleChange({target:t}){if("checkbox"===t.type&&t.hasAttribute("data-isbase")){const e=+t.checked,i={product_1s_id:this.product1sId,base_is_shippable:e};await(0,s.bE)("/adminsc/product/changeBaseIsShippable",i)}else this.update(e,this)}async update(t,e){let i=t.target.closest(".row");if(!+(0,s.$)(i).find("[select-new]").dataset.value)return!1;let a=e.dto(i);a.morphed.new_id=a.morphed.old_id,await(0,s.bE)("/adminsc/product/changeUnit",a)}dto(t){let e={product_id:this.product1sId,multiplier:+(0,s.$)(t).find(".multiplier").value??0,is_shippable:(0,s.$)(t).find(".shippable input").checked?1:null},i={new_id:0,old_id:+this.getUnitId(t),detach:0};return{baseUnitId:this.getBaseUnitId(),pivot:e,morphed:i}}getBaseUnitId(){return+this.$baseUnit.options[this.$baseUnit.selectedIndex].value}getUnitId(t){return t.querySelector("[select-new]").dataset.value??0}}(".units");class r{constructor(t){this.$product=t,this.$values=(0,s.$)(t).find(".values"),this.values=this.$values.querySelectorAll(".value"),this.$values.addEventListener("customSelect.changed",this.selectChanged.bind(this)),this.values.forEach((t=>{new d.A(t)}))}dto(){return{product_id:this.$product.dataset.id,morphed:{old_id:0,new_id:0}}}async selectChanged(t){let e=this.dto();e.morphed.old_id=t.detail.prev.value,e.morphed.new_id=t.detail.next.value,await(0,s.bE)("/adminsc/product/changeVal",e)}}class l{constructor(t){this.$product=t,this.$fields=(0,s.$)(".item_content").first(),this.$category_id=(0,s.$)('[data-field="category_id"]').first(),this.$promotions=(0,s.$)('[data-field="promotions"]').first(),this.$base_unit=(0,s.$)('[data-field="base_unit"]').first(),this.$manufacturer_id=(0,s.$)('[data-field="manufacturer_id"]').first(),this.$printName=(0,s.$)("[data-field='print_name']").first(),this.$printName.addEventListener("catalogItem.changed",this.changePrintName.bind(this)),this.$productUrl=(0,s.$)("[data-field='slug']").first(),this.setup()}setup(){this.$fields.addEventListener("customSelect.changed",this.changeFields.bind(this)),new d.A(this.$category_id),new d.A(this.$promotions),new d.A(this.$base_unit),new d.A(this.$manufacturer_id)}changePrintName(t){if(t.detail){let e=this.$productUrl.querySelector("a"),i=t.detail?.res?.arr?.model.slug;e.setAttribute("href",`/product/${i}`),e.text=i}}async checkBoxChanged({target:t}){let e=this.dto(this);e[t.dataset.field]=+t.checked,await(0,s.bE)("/adminsc/product/updateOrCreate",e)}async changeFields(t){let e=t.detail.target.dataset.field;if(!e)return;let i=this.dto(t);i[e]=t.detail.next.value,await(0,s.bE)("/adminsc/product/updateOrCreate",i)}dto(t){return{id:this.$product.dataset.id}}}async function c(){const t=document[n.qs](".item-wrap[data-model='product']");if(!t)return!1;new r(t),new l(t);const e=document[n.qs]("[dnd]");if(e){const{default:t}=await Promise.resolve().then(a.bind(a,529));new t(e,o)}}async function o(t,e){const i={productId:e.closest(".item-wrap").dataset.id};let a=(0,s.yF)(i,t[0]),d=await(0,s.bE)("/adminsc/product/saveMainImage",a),n=d?.arr[0];if(n){let t=e.closest(".dnd-container").querySelector("img");t.removeAttribute("src"),t.setAttribute("src",n)}}}}]);
//# sourceMappingURL=847.js.map