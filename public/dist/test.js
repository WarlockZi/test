!function(){"use strict";let e={show:function(e,t){let n=this.el("div","popup__close");n.innerText="X";let i=this.el("div","popup__item");i.innerText=e,i.append(n);let o=s(".popup").el[0];o||(o=this.el("div","popup")),o.append(i),o.addEventListener("click",this.close),document.body.append(o),setTimeout((()=>{i.classList.remove("popup__item"),i.classList.add("popup-hide")}),5e3),setTimeout((()=>{i.remove(),t&&t()}),5950)},close:function(e){e.target.classList.contains("popup__close")&&this.closest(".popup").remove()},el:function(e,t){let n=document.createElement(e);return n.classList.add(t),n}};async function t(e,t={}){return new Promise((function(n,s){t.token=document.querySelector('meta[name="token"]').getAttribute("content");let i=new XMLHttpRequest;i.open("POST",e,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),t instanceof FormData?i.send(t):(i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.send("param="+JSON.stringify(t))),i.onerror=function(){s(Error("Network Error"))},i.onload=async function(){n(i.response)}}))}function n(e){this.el=e,this.elType={}.toString.call(e),this.on=function(t,n){this.el&&("[object HTMLDivElement]"===this.elType&&this.el.addEventListener(t,n),"[object NodeList]"===this.elType&&e.forEach((e=>e.addEventListener(t,n))))},this.value=function(){return this.el[0].getAttribute("value")},this.attr=function(e,t){return t&&this.el[0].setAttribute(e,t),this.el[0].getAttribute(e)},this.selectedIndexValue=function(){if(this.el.length)return this.el[0].selectedOptions[0].value},this.options=function(){if(this.el.length)return this.el[0].options},this.count=function(){return this.el.length},this.text=function(){if(this.el.length)return this.el[0].innerText},this.checked=function(){if(this.el.length)return this.el[0].checked},this.getWithStyle=function(t,n){let s=[];return e.forEach((e=>{e.style[t]===n&&s.push(e)})),s},this.addClass=function(e){"[object HTMLDivElement]"===this.elType&&this.el.classList.add(e),["[object NodeList]","[object Array]"].includes(this.elType)&&this.el.forEach((t=>{t.classList.add(e)}))},this.removeClass=function(e){"[object HTMLDivElement]"===this.elType&&this.el.classList.remove(e),["[object NodeList]","[object Array]"].includes(this.elType)&&this.el.forEach((t=>{t.classList.remove(e)}))},this.hasClass=function(e){if(this.el.classList.contains(e))return!0},this.append=function(e){this.el[0].appendChild(e)},this.find=function(e){return["[object HTMLDivElement]","[object HTMLInputElement]"].includes(this.elType)?this.el.querySelector(e):["[object NodeList]","[object Array]"].includes(this.elType)?this.el[0].querySelector(e):void 0},this.css=function(t,n){if(!n)return this.el[0].style[t];"[object HTMLDivElement]"===this.elType&&(this.el.style[t]=n),"[object NodeList]"===this.elType&&e.forEach((e=>{e.style[t]=n}))}}function s(e){let t="";return t="string"==typeof e?document.querySelectorAll(e):e,new n(t)}[...s(".search input").el].map((e=>{e&&e.addEventListener("input",(function(){!async function(e){let t=s(e.parentNode).find(".search__result");if(e.value.length<1)return void(t&&(t.innerHTML=""));let n=await fetch("/search?q="+e.value);n=await n.json(n),0!==t.childNodes.length&&(t.innerHTML=""),n.map((e=>{let n=document.createElement("a");n.href=e.alias,n.innerHTML=`<img src='/pic/${e.preview_pic}' alt='${e.name}'>`+e.name,t.appendChild(n)})),s("body").on("click",(function(e){t&&e.target!==t&&(t.innerHTML="")}))}(e)}))})),document.cookie.match("(^|;)?cn=([^;]*)")?s("#cookie-notice").css("bottom","-100%"):s("#cookie-notice").css("bottom","0"),s("#cn-accept-cookie").on("click",(function(){(function(){const e=new Date;e.setTime(e.getTime()+864e5),document.cookie="cn=1; expires="+e+"path=/; SameSite=lax"})(),s("#cookie-notice").css("bottom","-100%")})),s(".question").removeClass("flex1"),s(".question:first-child").addClass("flex1"),s('[type="checkbox"]').on("click",(function(e){e.target.labels[0].classList.toggle("pushed")})),s(".test-do__finish-btn").on("click",(async function(e){let n=e.target;if("btnn"!==n.id)return!1;if("ПРОЙТИ ТЕСТ ЗАНОВО"==n.text)return void location.reload();let i=await t("/test/getCorrectAnswers",{});i=JSON.parse(i);let o=(a=function(e){let t=s(".question").el;return Array.from(t).map(((t,n)=>{let i=t.querySelectorAll(".a"),o=[];Array.from(i).map((t=>{let n=t.getElementsByTagName("input")[0],s=n.id.replace("answer-",""),i=t.getElementsByTagName("label")[0];(function(e,t,n){return t.checked&&e?(n.classList.add("done"),!0):!(t.checked&&!e)&&(!t.checked&&e?(n.classList.add("done"),n.classList.add("done"),!1):!t.checked&&!e||void 0)})(-1!==e.indexOf(s),n,i)||o.push(!0)}));let a=s('.pagination [data-pagination="'+ +t.dataset.id+'"]').el[0];o.length?s(a).addClass("redShadow"):s(a).addClass("greenShadow")})),s(".redShadow").el.length}(i),{token:document.querySelector('meta[name="token"]').getAttribute("content"),questionCnt:s(".question").el.length,errorCnt:a,pageCache:`<!DOCTYPE ${document.doctype.name}>`+document.documentElement.outerHTML,testId:s("[data-test-id]").el[0].dataset.testId,test_name:s(".test-name").el[0].innerText,userName:s(".user-menu__FIO").el[0].innerText});var a;await t("/test/cachePageSendEmail",o)&&(s("#btnn").el[0].href=location.href,s("#btnn").el[0].text="ПРОЙТИ ТЕСТ ЗАНОВО")}));let i={el:e=>{let t=e.parentNode.querySelectorAll(".answer"),n=0;t.length&&(n=+s(t[t.length-1]).find(".answer__sort").innerText);let o=s(".answer__create").find(".answer").cloneNode(!0);return o.classList.add("answer"),o.classList.remove("answer__create"),{el:o,id:"new",q_id:+e.closest(".question-edit").id,previous_sort:n,sort:s(o).find(".answer__sort"),checked:s(o).find("input"),text:s(o).find(".answer__text"),delete:s(s(o).find(".answer__delete")).on("click",(function(){i.del(this)}))}},getModelForServer:e=>({answer:"",parent_question:e.q_id,correct_answer:0,pica:""}),async create(e){let n=e.target;!function(e){let t=i.el(n);t.checked.checked=!1,t.el.dataset.answerId=e,t.text.innerText="",t.sort.innerText=t.previous_sort+1,t.el.style.display="flex",n.before(t.el),t.el.style.opacity=1}(await async function(e){let n=i.getModelForServer(i.el(e)),s=await t("/answer/create",n);return s=JSON.parse(s),s.id}(n))},async del(n){let s=n.target;confirm("Удалить этот ответ?")&&(await async function(n){let s=+n.closest(".answer").dataset.answerId,i=await t("/answer/delete",{a_id:s});i=JSON.parse(i),"ok"===i.msg&&e.show("Ответ удален")}(s),function(e){e.parentNode.remove()}(s))}},o={sort:async function(n){let i=[...o.questions()].filter((function(e,t){if(t+1<n)return e})),a=i.map((e=>e.id)),r=await t("/question/sort",{toChange:a});r=JSON.parse(r),r.msg&&e.show(r.msg),i.map(((e,t)=>{s(e).find(".question__sort").innerText=t+1}))},showFirst:()=>{let e=o.cloneEmptyModel();if(!e)return;let t=o.viewModel(e);t.sort.innerText="1",s(t.save).on("click",o.save),s(t.del).on("click",o.delete),s(e).addClass("question-edit"),s(e).removeClass("question__create"),s(".questions").el[0].prepend(e)},cloneEmptyModel:()=>{let e=s(".questions .question__create .question-edit").el[0];if(e)return e.cloneNode(!0)},showAnswers:e=>{let t=e.target,n=s(t.parentNode.parentNode).find(".question__answers");n.classList.toggle("height"),n.classList.toggle("scale"),t.classList.toggle("rotate")},viewModel:e=>({id:+e.id,el:e,sort:e.querySelector(".question__sort"),save:e.querySelector(".question__save"),text:e.querySelector(".question__text"),del:e.querySelector(".question__delete"),createAnswerButton:e.querySelector(".answer__create-button"),addButton:s(s(".questions").el[0]).find(".question__create-button")}),serverModel:()=>({question:{id:null,qustion:"",parent:+window.location.href.split("/").pop(),sort:o.questionsCount()}}),questions:()=>s(".questions>.question-edit").el,questionsCount:()=>s(".questions>.question-edit").el.length,create:async e=>{let t=await o.createOnServer(e);t&&o.createOnView(t)},createOnServer:async()=>{let e=o.serverModel(),n=await t("/question/updateOrCreate",{question:e.question,answers:{}});return n=await JSON.parse(n),n.id},createOnView:e=>{let t=o.cloneEmptyModel(),n=o.viewModel(t);s(n.save).on("click",o.save),s(n.del).on("click",o.delete),s(n.text).on("click",o.showAnswers),s(n.createAnswerButton).on("click",i.create),n.sort.innerText=o.questions().length+1,n.text.innerText="",n.el.id=e,n.addButton.before(t)},save:async n=>{let s=n.target.closest(".question-edit"),i=await t("/question/UpdateOrCreate",{question:o.getModelForServer(s),answers:o.getAnswers(s)});i=await JSON.parse(i),e.show(i.msg)},delete:async t=>{if(confirm("Удалить вопрос со всеми его ответами?")){let n=o.viewModel(t.target.closest(".question-edit")),s=n.id,i=await o.deleteFromServer(s);i&&(o.deleteFromView(n),e.show(i.msg))}},deleteFromView:async e=>{e.el.remove()},deleteFromServer:async e=>{let n=await t("/question/delete",{q_id:e});return JSON.parse(n)},getModelForServer:e=>({id:+e.id,parent:+s(".test-name").el[0].getAttribute("value"),picq:"",qustion:s(e).find(".question__text").innerText,sort:+s(e).find(".question__sort").innerText}),getAnswers:e=>[...e.querySelectorAll(".answer")].map((t=>({id:+t.dataset.answerId,answer:t.querySelector(".answer__text").innerText,correct_answer:+t.querySelector('[type="checkbox"]').checked,parent_question:+e.id,pica:""})),e)};s("[data-pagination]:first-child").addClass("nav-active"),s(".test-edit__content").addClass("flex1"),s(".pagination").on("click",(function(e){e.target.classList.contains("add-question")?async function(e){let n=+s(".test-name").value(),i=s("[data-pagination]").count(),a=await t("/question/show",{testid:n,questCount:i});a=JSON.parse(a);let r=a.block;s(".blocks").el[0].insertAdjacentHTML("afterBegin",r);let l=s(".blocks .block:first-child").el[0];document.querySelector(".flex1").classList.remove("flex1"),s(l).addClass("flex1");let c=s(l).find(".question__save");s(c).on("click",o().save)}():e.target.getAttribute("data-pagination")&&function(e){if(e.classList.contains("nav-active"))return;let t=s(".pagination .nav-active").el[0];t.classList.remove("nav-active"),e.classList.add("nav-active"),s(`#question-${t.dataset.pagination}`).removeClass("flex1"),s(`#question-${e.dataset.pagination}`).addClass("flex1")}(e.target)}))}();